/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var j=Object.defineProperty;var Se=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var be=Object.prototype.hasOwnProperty;var Ce=(c,i)=>{for(var e in i)j(c,e,{get:i[e],enumerable:!0})},xe=(c,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of Re(i))!be.call(c,s)&&s!==e&&j(c,s,{get:()=>i[s],enumerable:!(t=Se(i,s))||t.enumerable});return c};var Ee=c=>xe(j({},"__esModule",{value:!0}),c);var Oe={};Ce(Oe,{DASHBOARD_VIEW_TYPE:()=>D,default:()=>U});module.exports=Ee(Oe);var y=require("obsidian");var S={ai:{provider:"openai",apiKeys:{},model:"gpt-4o-mini"},review:{dailyLimit:20,newCardsPerDay:10,groupSimilar:!0,similarityThreshold:.7},quiz:{enabled:!0,questionCount:5,types:["multiple_choice","true_false","open_ended"],language:"ko",difficulty:"mixed"},notifications:{enabled:!0,reminderTime:"09:00",showBadge:!0},excludeFolders:["templates","attachments"],advanced:{debugMode:!1,cacheEmbeddings:!0,maxHistorySize:20}},P={claude:[{id:"claude-opus-4-5-20251101",name:"Claude Opus 4.5",description:"\uCD5C\uACE0 \uD488\uC9C8"},{id:"claude-sonnet-4-5-20250514",name:"Claude Sonnet 4.5",description:"\uACE0\uD488\uC9C8 \uADE0\uD615"},{id:"claude-3-5-haiku-20241022",name:"Claude 3.5 Haiku",description:"\uBE60\uB978 \uC18D\uB3C4"}],openai:[{id:"gpt-5.2",name:"GPT-5.2",description:"\uCD5C\uC2E0 \uD50C\uB798\uADF8\uC2ED"},{id:"gpt-5.2-codex",name:"GPT-5.2 Codex",description:"\uCF54\uB529 \uD2B9\uD654"},{id:"gpt-4o-mini",name:"GPT-4o Mini",description:"\uBE60\uB974\uACE0 \uACBD\uC81C\uC801"},{id:"gpt-4o",name:"GPT-4o",description:"\uACE0\uD488\uC9C8"},{id:"o3-mini",name:"O3 Mini",description:"Reasoning \uBAA8\uB378"}],gemini:[{id:"gemini-3-flash-preview",name:"Gemini 3 Flash",description:"\uBE60\uB978 \uC18D\uB3C4"},{id:"gemini-3-pro-preview",name:"Gemini 3 Pro",description:"\uCD5C\uACE0 \uD488\uC9C8"},{id:"gemini-2.0-flash",name:"Gemini 2.0 Flash",description:"\uC548\uC815\uC801"}],grok:[{id:"grok-4-1-fast",name:"Grok 4.1 Fast",description:"xAI \uCD5C\uC2E0 \uBAA8\uB378"}]};function Y(c){return{...S,...c,ai:{...S.ai,...c.ai},review:{...S.review,...c.review},quiz:{...S.quiz,...c.quiz},notifications:{...S.notifications,...c.notifications},advanced:{...S.advanced,...c.advanced}}}var p=require("obsidian");var A=class extends p.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;i.empty(),i.addClass("srs-settings"),i.createEl("h1",{text:"Spaced Repetition Scheduler"}),i.createEl("p",{text:"SM-2 \uC54C\uACE0\uB9AC\uC998 \uAE30\uBC18 \uAC04\uACA9 \uBC18\uBCF5 \uD559\uC2B5 \uC2DC\uC2A4\uD15C",cls:"setting-item-description"}),this.renderAISection(i),this.renderReviewSection(i),this.renderQuizSection(i),this.renderNotificationSection(i),this.renderAdvancedSection(i)}renderAISection(i){i.createEl("h2",{text:"AI \uC124\uC815"});let e=i.createDiv("srs-settings-section");new p.Setting(e).setName("LLM Provider").setDesc("\uD034\uC988 \uC0DD\uC131\uC5D0 \uC0AC\uC6A9\uD560 AI \uC11C\uBE44\uC2A4").addDropdown(n=>{n.addOption("openai","OpenAI").addOption("claude","Anthropic Claude").addOption("gemini","Google Gemini").addOption("grok","xAI Grok").setValue(this.plugin.settings.ai.provider).onChange(async a=>{this.plugin.settings.ai.provider=a;let o=P[a];o&&o.length>0&&(this.plugin.settings.ai.model=o[0].id),await this.plugin.saveSettings(),this.display()})});let t=this.plugin.settings.ai.provider,s=this.getProviderDisplayName(t);new p.Setting(e).setName(`${s} API Key`).setDesc(`${s} API \uD0A4\uB97C \uC785\uB825\uD558\uC138\uC694`).addText(n=>{n.setPlaceholder("sk-...").setValue(this.plugin.settings.ai.apiKeys[t]||"").onChange(async a=>{this.plugin.settings.ai.apiKeys[t]=a,await this.plugin.saveSettings()}),n.inputEl.type="password"}).addExtraButton(n=>{n.setIcon("external-link").setTooltip(`${s} API \uD0A4 \uBC1C\uAE09`).onClick(()=>{window.open(this.getProviderApiUrl(t),"_blank")})});let r=P[t]||[];new p.Setting(e).setName("\uBAA8\uB378").setDesc("\uC0AC\uC6A9\uD560 AI \uBAA8\uB378").addDropdown(n=>{r.forEach(a=>{n.addOption(a.id,`${a.name}${a.description?` - ${a.description}`:""}`)}),n.setValue(this.plugin.settings.ai.model).onChange(async a=>{this.plugin.settings.ai.model=a,await this.plugin.saveSettings()})}),new p.Setting(e).setName("API \uC5F0\uACB0 \uD14C\uC2A4\uD2B8").setDesc("API \uD0A4\uAC00 \uC62C\uBC14\uB978\uC9C0 \uD655\uC778\uD569\uB2C8\uB2E4").addButton(n=>{n.setButtonText("\uD14C\uC2A4\uD2B8").onClick(async()=>{n.setDisabled(!0),n.setButtonText("\uD14C\uC2A4\uD2B8 \uC911...");try{await this.plugin.testApiConnection()?new p.Notice("API \uC5F0\uACB0 \uC131\uACF5!"):new p.Notice("API \uC5F0\uACB0 \uC2E4\uD328. \uD0A4\uB97C \uD655\uC778\uD574\uC8FC\uC138\uC694.")}catch(a){new p.Notice(`\uC624\uB958: ${a instanceof Error?a.message:"\uC54C \uC218 \uC5C6\uB294 \uC624\uB958"}`)}n.setDisabled(!1),n.setButtonText("\uD14C\uC2A4\uD2B8")})})}renderReviewSection(i){i.createEl("h2",{text:"\uBCF5\uC2B5 \uC124\uC815"});let e=i.createDiv("srs-settings-section");new p.Setting(e).setName("\uC77C\uC77C \uBCF5\uC2B5 \uC81C\uD55C").setDesc("\uD558\uB8E8\uC5D0 \uBCF5\uC2B5\uD560 \uCD5C\uB300 \uCE74\uB4DC \uC218").addSlider(t=>{t.setLimits(5,100,5).setValue(this.plugin.settings.review.dailyLimit).setDynamicTooltip().onChange(async s=>{this.plugin.settings.review.dailyLimit=s,await this.plugin.saveSettings()})}),new p.Setting(e).setName("\uC77C\uC77C \uC0C8 \uCE74\uB4DC").setDesc("\uD558\uB8E8\uC5D0 \uB4F1\uB85D\uD560 \uC0C8 \uCE74\uB4DC \uC218").addSlider(t=>{t.setLimits(1,50,1).setValue(this.plugin.settings.review.newCardsPerDay).setDynamicTooltip().onChange(async s=>{this.plugin.settings.review.newCardsPerDay=s,await this.plugin.saveSettings()})}),new p.Setting(e).setName("\uC720\uC0AC \uB178\uD2B8 \uADF8\uB8F9\uD551").setDesc("\uC784\uBCA0\uB529 \uAE30\uBC18\uC73C\uB85C \uC720\uC0AC\uD55C \uB178\uD2B8\uB97C \uD568\uAED8 \uBCF5\uC2B5 (Vault Embeddings \uD544\uC694)").addToggle(t=>{t.setValue(this.plugin.settings.review.groupSimilar).onChange(async s=>{this.plugin.settings.review.groupSimilar=s,await this.plugin.saveSettings()})}),this.plugin.settings.review.groupSimilar&&new p.Setting(e).setName("\uC720\uC0AC\uB3C4 \uC784\uACC4\uAC12").setDesc("\uADF8\uB8F9\uD551\uC5D0 \uD544\uC694\uD55C \uCD5C\uC18C \uC720\uC0AC\uB3C4 (0.5 ~ 1.0)").addSlider(t=>{t.setLimits(.5,1,.05).setValue(this.plugin.settings.review.similarityThreshold).setDynamicTooltip().onChange(async s=>{this.plugin.settings.review.similarityThreshold=s,await this.plugin.saveSettings()})}),new p.Setting(e).setName("\uC81C\uC678 \uD3F4\uB354").setDesc("\uBCF5\uC2B5\uC5D0\uC11C \uC81C\uC678\uD560 \uD3F4\uB354 (\uC27C\uD45C\uB85C \uAD6C\uBD84)").addText(t=>{t.setPlaceholder("templates, attachments").setValue(this.plugin.settings.excludeFolders.join(", ")).onChange(async s=>{this.plugin.settings.excludeFolders=s.split(",").map(r=>r.trim()).filter(r=>r.length>0),await this.plugin.saveSettings()})})}renderQuizSection(i){i.createEl("h2",{text:"\uD034\uC988 \uC124\uC815"});let e=i.createDiv("srs-settings-section");new p.Setting(e).setName("\uD034\uC988 \uD65C\uC131\uD654").setDesc("AI \uC0DD\uC131 \uD034\uC988\uB85C \uAE4A\uC740 \uBCF5\uC2B5 \uBAA8\uB4DC \uD65C\uC131\uD654").addToggle(t=>{t.setValue(this.plugin.settings.quiz.enabled).onChange(async s=>{this.plugin.settings.quiz.enabled=s,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.quiz.enabled&&(new p.Setting(e).setName("\uC9C8\uBB38 \uC218").setDesc("\uB178\uD2B8\uB2F9 \uC0DD\uC131\uD560 \uD034\uC988 \uC9C8\uBB38 \uC218").addSlider(t=>{t.setLimits(1,10,1).setValue(this.plugin.settings.quiz.questionCount).setDynamicTooltip().onChange(async s=>{this.plugin.settings.quiz.questionCount=s,await this.plugin.saveSettings()})}),new p.Setting(e).setName("\uC9C8\uBB38 \uC720\uD615").setDesc("\uC0DD\uC131\uD560 \uC9C8\uBB38 \uC720\uD615\uC744 \uC120\uD0DD\uD558\uC138\uC694 (\uCD5C\uC18C 1\uAC1C \uD544\uC694)").setHeading(),new p.Setting(e).setName("\uAC1D\uAD00\uC2DD").setDesc("4\uC9C0\uC120\uB2E4 \uAC1D\uAD00\uC2DD \uBB38\uC81C").addToggle(t=>{t.setValue(this.plugin.settings.quiz.types.includes("multiple_choice")).onChange(async s=>{this.updateQuizTypes("multiple_choice",s)})}),new p.Setting(e).setName("\uCC38/\uAC70\uC9D3").setDesc("\uCC38 \uB610\uB294 \uAC70\uC9D3\uC744 \uC120\uD0DD\uD558\uB294 \uBB38\uC81C").addToggle(t=>{t.setValue(this.plugin.settings.quiz.types.includes("true_false")).onChange(async s=>{this.updateQuizTypes("true_false",s)})}),new p.Setting(e).setName("\uC11C\uC220\uD615").setDesc("\uC9C1\uC811 \uB2F5\uC744 \uC791\uC131\uD558\uB294 \uBB38\uC81C").addToggle(t=>{t.setValue(this.plugin.settings.quiz.types.includes("open_ended")).onChange(async s=>{this.updateQuizTypes("open_ended",s)})}),new p.Setting(e).setName("\uC5B8\uC5B4").setDesc("\uD034\uC988 \uC0DD\uC131 \uC5B8\uC5B4").addDropdown(t=>{t.addOption("ko","\uD55C\uAD6D\uC5B4").addOption("en","English").setValue(this.plugin.settings.quiz.language).onChange(async s=>{this.plugin.settings.quiz.language=s,await this.plugin.saveSettings()})}),new p.Setting(e).setName("\uB09C\uC774\uB3C4").setDesc("\uD034\uC988 \uB09C\uC774\uB3C4").addDropdown(t=>{t.addOption("easy","\uC26C\uC6C0").addOption("medium","\uC911\uAC04").addOption("hard","\uC5B4\uB824\uC6C0").addOption("mixed","\uD63C\uD569").setValue(this.plugin.settings.quiz.difficulty).onChange(async s=>{this.plugin.settings.quiz.difficulty=s,await this.plugin.saveSettings()})}))}renderNotificationSection(i){i.createEl("h2",{text:"\uC54C\uB9BC \uC124\uC815"});let e=i.createDiv("srs-settings-section");new p.Setting(e).setName("\uC54C\uB9BC \uD65C\uC131\uD654").setDesc("\uBCF5\uC2B5 \uC54C\uB9BC \uBC1B\uAE30").addToggle(t=>{t.setValue(this.plugin.settings.notifications.enabled).onChange(async s=>{this.plugin.settings.notifications.enabled=s,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.notifications.enabled&&(new p.Setting(e).setName("\uC54C\uB9BC \uC2DC\uAC04").setDesc("\uBCF5\uC2B5 \uC54C\uB9BC\uC744 \uBC1B\uC744 \uC2DC\uAC04 (HH:MM)").addText(t=>{t.setPlaceholder("09:00").setValue(this.plugin.settings.notifications.reminderTime).onChange(async s=>{/^([01]\d|2[0-3]):([0-5]\d)$/.test(s)&&(this.plugin.settings.notifications.reminderTime=s,await this.plugin.saveSettings())})}),new p.Setting(e).setName("\uBC30\uC9C0 \uD45C\uC2DC").setDesc("\uB9AC\uBCF8 \uC544\uC774\uCF58\uC5D0 \uC624\uB298 \uBCF5\uC2B5 \uC218 \uD45C\uC2DC").addToggle(t=>{t.setValue(this.plugin.settings.notifications.showBadge).onChange(async s=>{this.plugin.settings.notifications.showBadge=s,await this.plugin.saveSettings()})}))}renderAdvancedSection(i){i.createEl("h2",{text:"\uACE0\uAE09 \uC124\uC815"});let e=i.createDiv("srs-settings-section");new p.Setting(e).setName("\uB514\uBC84\uADF8 \uBAA8\uB4DC").setDesc("\uCF58\uC194\uC5D0 \uC0C1\uC138 \uB85C\uADF8 \uCD9C\uB825").addToggle(t=>{t.setValue(this.plugin.settings.advanced.debugMode).onChange(async s=>{this.plugin.settings.advanced.debugMode=s,await this.plugin.saveSettings()})}),new p.Setting(e).setName("\uC784\uBCA0\uB529 \uCE90\uC2DC").setDesc("\uC784\uBCA0\uB529 \uB370\uC774\uD130\uB97C \uBA54\uBAA8\uB9AC\uC5D0 \uCE90\uC2DC\uD558\uC5EC \uC131\uB2A5 \uD5A5\uC0C1").addToggle(t=>{t.setValue(this.plugin.settings.advanced.cacheEmbeddings).onChange(async s=>{this.plugin.settings.advanced.cacheEmbeddings=s,await this.plugin.saveSettings()})}),new p.Setting(e).setName("\uD788\uC2A4\uD1A0\uB9AC \uD06C\uAE30").setDesc("\uB178\uD2B8\uB2F9 \uC800\uC7A5\uD560 \uCD5C\uB300 \uBCF5\uC2B5 \uAE30\uB85D \uC218").addSlider(t=>{t.setLimits(10,100,10).setValue(this.plugin.settings.advanced.maxHistorySize).setDynamicTooltip().onChange(async s=>{this.plugin.settings.advanced.maxHistorySize=s,await this.plugin.saveSettings()})}),new p.Setting(e).setName("\uC124\uC815 \uCD08\uAE30\uD654").setDesc("\uBAA8\uB4E0 \uC124\uC815\uC744 \uAE30\uBCF8\uAC12\uC73C\uB85C \uB418\uB3CC\uB9BD\uB2C8\uB2E4").addButton(t=>{t.setButtonText("\uCD08\uAE30\uD654").setWarning().onClick(async()=>{await this.plugin.resetSettings(),new p.Notice("\uC124\uC815\uC774 \uCD08\uAE30\uD654\uB418\uC5C8\uC2B5\uB2C8\uB2E4."),this.display()})})}getProviderDisplayName(i){return{openai:"OpenAI",claude:"Anthropic",gemini:"Google",grok:"xAI"}[i]}getProviderApiUrl(i){return{openai:"https://platform.openai.com/api-keys",claude:"https://console.anthropic.com/settings/keys",gemini:"https://aistudio.google.com/app/apikey",grok:"https://console.x.ai/"}[i]}async updateQuizTypes(i,e){let t=new Set(this.plugin.settings.quiz.types);e?t.add(i):t.delete(i),t.size===0&&t.add("multiple_choice"),this.plugin.settings.quiz.types=Array.from(t),await this.plugin.saveSettings()}};var se={"claude-opus-4-5-20251101":{id:"claude-opus-4-5-20251101",displayName:"Claude Opus 4.5",provider:"claude",maxTokens:32768,contextWindow:2e5,isReasoning:!1},"claude-sonnet-4-5-20250514":{id:"claude-sonnet-4-5-20250514",displayName:"Claude Sonnet 4.5",provider:"claude",maxTokens:16384,contextWindow:2e5,isReasoning:!1},"claude-3-5-haiku-20241022":{id:"claude-3-5-haiku-20241022",displayName:"Claude 3.5 Haiku",provider:"claude",maxTokens:8192,contextWindow:2e5,isReasoning:!1},"gpt-4o":{id:"gpt-4o",displayName:"GPT-4o",provider:"openai",maxTokens:16384,contextWindow:128e3,isReasoning:!1},"gpt-4o-mini":{id:"gpt-4o-mini",displayName:"GPT-4o Mini",provider:"openai",maxTokens:16384,contextWindow:128e3,isReasoning:!1},"gpt-5.2":{id:"gpt-5.2",displayName:"GPT-5.2",provider:"openai",maxTokens:32768,contextWindow:4e5,isReasoning:!1},"gpt-5.2-codex":{id:"gpt-5.2-codex",displayName:"GPT-5.2 Codex",provider:"openai",maxTokens:32768,contextWindow:4e5,isReasoning:!1},"o3-mini":{id:"o3-mini",displayName:"O3 Mini",provider:"openai",maxTokens:65536,contextWindow:128e3,isReasoning:!0},o1:{id:"o1",displayName:"O1",provider:"openai",maxTokens:65536,contextWindow:128e3,isReasoning:!0},"o1-mini":{id:"o1-mini",displayName:"O1 Mini",provider:"openai",maxTokens:65536,contextWindow:128e3,isReasoning:!0},"gemini-3-flash-preview":{id:"gemini-3-flash-preview",displayName:"Gemini 3 Flash",provider:"gemini",maxTokens:8192,contextWindow:1e6,isReasoning:!1},"gemini-3-pro-preview":{id:"gemini-3-pro-preview",displayName:"Gemini 3 Pro",provider:"gemini",maxTokens:8192,contextWindow:2e6,isReasoning:!1},"gemini-2.0-flash":{id:"gemini-2.0-flash",displayName:"Gemini 2.0 Flash",provider:"gemini",maxTokens:8192,contextWindow:1e6,isReasoning:!1},"grok-4-1-fast":{id:"grok-4-1-fast",displayName:"Grok 4.1 Fast",provider:"grok",maxTokens:16384,contextWindow:131072,isReasoning:!1}};function J(c){return se[c]}function L(c){var i,e;return(e=(i=se[c])==null?void 0:i.isReasoning)!=null?e:!1}var Z=class{constructor(i){this.settings=i,this.modelConfig=J(i.modelId)}updateSettings(i){this.settings=i,this.modelConfig=J(i.modelId)}getSettings(){return{...this.settings}}isCurrentModelReasoning(){return L(this.settings.modelId)}hasApiKey(){let i=this.settings.apiKeys[this.settings.provider];return!!i&&i.length>0}getApiKey(){return this.settings.apiKeys[this.settings.provider]}getModelConfig(){return this.modelConfig}async generate(i,e){throw new Error("AIService.generate() requires LLM provider injection")}async simpleGenerate(i,e,t){let s=[];return e&&s.push({role:"system",content:e}),s.push({role:"user",content:i}),this.generate(s,t)}},k=null;function re(c){return k=new Z(c),k}function ne(){return k}function ae(){k=null}var X=require("obsidian");var g=require("obsidian"),z=class{constructor(i){this.app=i}async readFile(i){let e=(0,g.normalizePath)(i),t=this.app.vault.getAbstractFileByPath(e);if(t instanceof g.TFile)return await this.app.vault.read(t);try{return await this.app.vault.adapter.read(e)}catch(s){return null}}async fileExists(i){let e=(0,g.normalizePath)(i);if(this.app.vault.getAbstractFileByPath(e)instanceof g.TFile)return!0;try{return await this.app.vault.adapter.exists(e)}catch(s){return!1}}async folderExists(i){let e=(0,g.normalizePath)(i);if(this.app.vault.getAbstractFileByPath(e)instanceof g.TFolder)return!0;try{return await this.app.vault.adapter.exists(e)}catch(s){return!1}}async writeFile(i,e){let t=(0,g.normalizePath)(i),s=this.app.vault.getAbstractFileByPath(t);if(s instanceof g.TFile){await this.app.vault.modify(s,e);return}try{await this.app.vault.create(t,e)}catch(r){if((r instanceof Error?r.message:"").toLowerCase().includes("already exists")){await this.app.vault.adapter.write(t,e);return}throw r}}async ensureFolder(i){let e=(0,g.normalizePath)(i),t=this.app.vault.getAbstractFileByPath(e);if(!(t instanceof g.TFolder)){if(t instanceof g.TFile)throw new Error(`Path exists as file: ${e}`);try{await this.app.vault.createFolder(e)}catch(s){if((s instanceof Error?s.message:"").toLowerCase().includes("already exists"))return;throw s}}}async deleteFile(i){let e=(0,g.normalizePath)(i),t=this.app.vault.getAbstractFileByPath(e);if(t instanceof g.TFile){await this.app.vault.delete(t);return}try{await this.app.vault.adapter.exists(e)&&await this.app.vault.adapter.remove(e)}catch(s){}}getFile(i){let e=(0,g.normalizePath)(i),t=this.app.vault.getAbstractFileByPath(e);return t instanceof g.TFile?t:null}getFolder(i){let e=(0,g.normalizePath)(i),t=this.app.vault.getAbstractFileByPath(e);return t instanceof g.TFolder?t:null}};var N=class{constructor(i){this.app=i;this.cache=new Map;this.cacheInitialized=!1;this.embeddingsReader=null;this.fileUtils=new z(i)}setEmbeddingsReader(i){this.embeddingsReader=i}async getCard(i){var e;return this.cache.has(i)?this.cache.get(i):this.cacheInitialized?null:(await this.initializeCache(),(e=this.cache.get(i))!=null?e:null)}async getAllCards(){return this.cacheInitialized||await this.initializeCache(),Array.from(this.cache.values())}async saveCard(i){if(!this.fileUtils.getFile(i.notePath))throw new Error(`Note not found: ${i.notePath}`);let t=await this.fileUtils.readFile(i.notePath);if(t===null)throw new Error(`Failed to read note: ${i.notePath}`);let s=this.updateFrontmatter(t,i);await this.fileUtils.writeFile(i.notePath,s),this.cache.set(i.noteId,i)}async deleteCard(i){let e=this.cache.get(i);if(!e)return;let t=await this.fileUtils.readFile(e.notePath);if(t===null)return;let s=this.removeSRSFromFrontmatter(t);await this.fileUtils.writeFile(e.notePath,s),this.cache.delete(i)}async getStatistics(){let i=await this.getAllCards(),e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate()),s=new Date(t);s.setDate(s.getDate()-7);let r={totalCards:i.length,byRetentionLevel:{novice:0,learning:0,intermediate:0,advanced:0,mastered:0},averageEaseFactor:0,reviewsToday:0,reviewsThisWeek:0,streak:0,longestStreak:0,totalReviewCount:0,averageQuality:0};if(i.length===0)return r;let n=0,a=0,o=0;for(let u of i){r.byRetentionLevel[u.retentionLevel]++,n+=u.sm2State.easeFactor;for(let h of u.reviewHistory){r.totalReviewCount++,a+=h.quality,o++;let v=new Date(h.reviewedAt);v>=t&&r.reviewsToday++,v>=s&&r.reviewsThisWeek++}}r.averageEaseFactor=n/i.length,r.averageQuality=o>0?a/o:0;let{streak:l,longestStreak:d}=this.calculateStreak(i);return r.streak=l,r.longestStreak=d,r}async getDueTodayCount(){let i=await this.getAllCards(),e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59);return i.filter(s=>new Date(s.sm2State.nextReview)<=t).length}async getReviewHistory(i,e){let t=await this.getAllCards(),s=[];for(let r of t)for(let n of r.reviewHistory){let a=new Date(n.reviewedAt);a>=i&&a<=e&&s.push({noteId:r.noteId,noteTitle:r.noteTitle,reviewedAt:a,quality:n.quality,mode:n.mode})}return s.sort((r,n)=>n.reviewedAt.getTime()-r.reviewedAt.getTime()),s}async initializeCache(){if(this.cache.clear(),this.embeddingsReader&&await this.embeddingsReader.isAvailable()){await this.initializeCacheFromVE(),this.cacheInitialized=!0;return}await this.initializeCacheFromFrontmatter(),this.cacheInitialized=!0}async initializeCacheFromVE(){if(!this.embeddingsReader)return;let i=await this.embeddingsReader.readIndex();if(!i)return;let e=Object.entries(i.notes);for(let[t,s]of e){if(!await this.fileUtils.fileExists(s.path))continue;let n=await this.fileUtils.readFile(s.path);if(n===null)continue;let a=this.parseFrontmatter(n);if(a){let o=await this.toReviewCardFromPath(s.path,a);this.cache.set(o.noteId,o)}else{let o=await this.createDefaultCardFromPath(t,s.path);this.cache.set(t,o)}}}async initializeCacheFromFrontmatter(){let i=this.app.vault.getMarkdownFiles();for(let e of i){let t=await this.fileUtils.readFile(e.path);if(t===null)continue;let s=this.parseFrontmatter(t);if(!s)continue;let r=this.toReviewCard(e,s);this.cache.set(r.noteId,r)}}async createDefaultCardFromPath(i,e){var d;let t=(0,X.normalizePath)(e),s=new Date,n={repetition:0,interval:0,easeFactor:2.5,nextReview:new Date("9999-12-31")},a=s,o=s;try{let u=await this.app.vault.adapter.stat(t);u&&(a=new Date(u.ctime),o=new Date(u.mtime))}catch(u){}let l=((d=t.split("/").pop())==null?void 0:d.replace(/\.md$/,""))||i;return{noteId:i,notePath:t,noteTitle:l,sm2State:n,retentionLevel:"novice",reviewHistory:[],tags:[],createdAt:a,lastModified:o}}async toReviewCardFromPath(i,e){var l;let t=(0,X.normalizePath)(i),s={repetition:e.repetition,interval:e.interval,easeFactor:e.easeFactor,nextReview:new Date(e.nextReview)},r=(e.reviewHistory||[]).map(d=>({reviewedAt:new Date(d.date),quality:d.quality,mode:d.mode,quizScore:d.quizScore})),n=new Date,a=new Date;try{let d=await this.app.vault.adapter.stat(t);d&&(n=new Date(d.ctime),a=new Date(d.mtime))}catch(d){}let o=((l=t.split("/").pop())==null?void 0:l.replace(/\.md$/,""))||e.noteId;return{noteId:e.noteId,notePath:t,noteTitle:o,sm2State:s,retentionLevel:e.retentionLevel,reviewHistory:r,tags:[],createdAt:n,lastModified:a}}invalidateCache(){this.cacheInitialized=!1,this.cache.clear()}async introduceNewCard(i){let e=this.cache.get(i);return e?(e.sm2State.repetition>0||e.sm2State.nextReview.getFullYear()<9999||(e.sm2State.nextReview=new Date,await this.saveCard(e)),!0):!1}async getUnintroducedCards(){return(await this.getAllCards()).filter(e=>e.sm2State.repetition===0&&e.sm2State.nextReview.getFullYear()===9999)}async getIntroducedCards(){return(await this.getAllCards()).filter(e=>e.sm2State.repetition>0||e.sm2State.nextReview.getFullYear()<9999)}parseFrontmatter(i){let e=i.match(/^---\n([\s\S]*?)\n---/);if(!e)return null;let s=e[1].match(/^srs:\s*\n((?:  .+\n?)*)/m);if(!s)return null;try{let r=s[1],n=this.extractValue(r,"noteId"),a=parseInt(this.extractValue(r,"repetition")||"0",10),o=parseInt(this.extractValue(r,"interval")||"0",10),l=parseFloat(this.extractValue(r,"easeFactor")||"2.5"),d=this.extractValue(r,"nextReview"),u=this.extractValue(r,"retentionLevel");if(!n||!d)return null;let h=this.parseReviewHistory(r);return{noteId:n,repetition:a,interval:o,easeFactor:l,nextReview:d,retentionLevel:u||"novice",reviewHistory:h}}catch(r){return console.error("[SRS] Failed to parse frontmatter:",r),null}}extractValue(i,e){let t=i.match(new RegExp(`^\\s*${e}:\\s*["']?([^"'\\n]+)["']?`,"m"));return t?t[1].trim():""}parseReviewHistory(i){let e=[],t=i.match(/reviewHistory:\s*\n((?:\s*-.+\n?)*)/);if(!t)return e;let s=t[1].match(/-\s*\n(?:\s+.+\n?)*/g);if(!s)return e;for(let r of s){let n=this.extractValue(r,"date"),a=parseInt(this.extractValue(r,"quality")||"0",10),o=this.extractValue(r,"mode"),l=this.extractValue(r,"quizScore");n&&o&&e.push({date:n,quality:a,mode:o,quizScore:l?parseInt(l,10):void 0})}return e}toReviewCard(i,e){let t={repetition:e.repetition,interval:e.interval,easeFactor:e.easeFactor,nextReview:new Date(e.nextReview)},s=(e.reviewHistory||[]).map(r=>({reviewedAt:new Date(r.date),quality:r.quality,mode:r.mode,quizScore:r.quizScore}));return{noteId:e.noteId,notePath:i.path,noteTitle:i.basename,sm2State:t,retentionLevel:e.retentionLevel,reviewHistory:s,tags:[],createdAt:new Date(i.stat.ctime),lastModified:new Date(i.stat.mtime)}}updateFrontmatter(i,e){let t=this.buildSRSYaml(e),s=i.match(/^---\n([\s\S]*?)\n---/);if(!s)return`---
${t}---

${i}`;let n=s[1].replace(/^srs:\s*\n(?:  .+\n?)*/m,"").trim(),a=n?`${n}
${t}`:t;return i.replace(/^---\n[\s\S]*?\n---/,`---
${a}---`)}buildSRSYaml(i){let e=["srs:",`  noteId: "${i.noteId}"`,`  repetition: ${i.sm2State.repetition}`,`  interval: ${i.sm2State.interval}`,`  easeFactor: ${i.sm2State.easeFactor.toFixed(2)}`,`  nextReview: "${this.formatDate(i.sm2State.nextReview)}"`,`  retentionLevel: "${i.retentionLevel}"`];if(i.reviewHistory.length>0){e.push("  reviewHistory:");let t=i.reviewHistory.slice(-20);for(let s of t)e.push("    -"),e.push(`      date: "${this.formatDate(s.reviewedAt)}"`),e.push(`      quality: ${s.quality}`),e.push(`      mode: "${s.mode}"`),s.quizScore!==void 0&&e.push(`      quizScore: ${s.quizScore}`)}return e.join(`
`)+`
`}removeSRSFromFrontmatter(i){let e=i.match(/^---\n([\s\S]*?)\n---/);if(!e)return i;let s=e[1].replace(/^srs:\s*\n(?:  .+\n?)*/m,"").trim();return s?i.replace(/^---\n[\s\S]*?\n---/,`---
${s}
---`):i.replace(/^---\n[\s\S]*?\n---\n*/,"")}formatDate(i){return i.toISOString().split("T")[0]}calculateStreak(i){let e=new Set;for(let o of i)for(let l of o.reviewHistory)e.add(this.formatDate(new Date(l.reviewedAt)));if(e.size===0)return{streak:0,longestStreak:0};let t=Array.from(e).sort().reverse(),s=0,r=0,n=0;for(let o=0;o<t.length;o++){let l=new Date;l.setDate(l.getDate()-o);let d=this.formatDate(l);if(t.includes(d))s++;else break}let a=Array.from(e).sort();for(let o=0;o<a.length;o++)if(o===0)n=1;else{let l=new Date(a[o-1]);(new Date(a[o]).getTime()-l.getTime())/(1e3*60*60*24)===1?n++:(r=Math.max(r,n),n=1)}return r=Math.max(r,n),{streak:s,longestStreak:r}}};var Q=require("obsidian");var q="09_Embedded",ee="index.json",oe="embeddings";function De(c){let i=0;for(let e=0;e<c.length;e++){let t=c.charCodeAt(e);i=(i<<5)-i+t,i=i&i}return Math.abs(i).toString(16).padStart(8,"0")}function te(c){let i=c.replace(/\.md$/,"");return De(i)}function ce(c){return c.replace(/[^a-zA-Z0-9-_]/g,"_")}var O=class{constructor(i){this.vault=i;this.cachedIndex=null;this.indexCacheTime=0;this.embeddingsCache=new Map}async isAvailable(){let i=(0,Q.normalizePath)(`${q}/${ee}`);try{return await this.vault.adapter.exists(i)}catch(e){return!1}}async readIndex(){let i=Date.now();if(this.cachedIndex&&i-this.indexCacheTime<6e4)return this.cachedIndex;let e=(0,Q.normalizePath)(`${q}/${ee}`);try{if(!this.vault.getAbstractFileByPath(e)&&!await this.vault.adapter.exists(e))return null;let s=await this.vault.adapter.read(e);return this.cachedIndex=JSON.parse(s),this.indexCacheTime=i,this.cachedIndex}catch(t){return console.error("[SRS] Failed to read embedding index:",t),null}}async readEmbedding(i){let e=this.embeddingsCache.get(i);if(e)return e;let t=ce(i),s=(0,Q.normalizePath)(`${q}/${oe}/${t}.json`);try{if(!await this.vault.adapter.exists(s))return null;let n=await this.vault.adapter.read(s),a=JSON.parse(n);return this.embeddingsCache.set(i,a),a}catch(r){return console.error(`[SRS] Failed to read embedding for ${i}:`,r),null}}async readAllEmbeddings(){let i=await this.readIndex();if(!i)return new Map;let e=Object.keys(i.notes);for(let t=0;t<e.length;t+=50){let s=e.slice(t,t+50);await Promise.all(s.map(r=>this.readEmbedding(r)))}return this.embeddingsCache}async readEmbeddingsBatch(i){let e=new Map;for(let t=0;t<i.length;t+=50){let s=i.slice(t,t+50),r=await Promise.all(s.map(n=>this.readEmbedding(n)));s.forEach((n,a)=>{let o=r[a];o&&e.set(n,o)})}return e}clearCache(){this.cachedIndex=null,this.indexCacheTime=0,this.embeddingsCache.clear()}};var ie={novice:0,learning:1,intermediate:2,advanced:3,mastered:4};var _=class{calculateNext(i,e){let{sm2State:t}=i;if(e<3)return{repetition:0,interval:1,easeFactor:Math.max(1.3,t.easeFactor-.2),nextReview:this.addDays(new Date,1)};let s;t.repetition===0?s=1:t.repetition===1?s=6:s=Math.round(t.interval*t.easeFactor);let r=t.easeFactor+(.1-(5-e)*(.08+(5-e)*.02));return{repetition:t.repetition+1,interval:s,easeFactor:Math.max(1.3,r),nextReview:this.addDays(new Date,s)}}getDueCards(i,e=new Date){let t=this.startOfDay(e);return i.filter(s=>this.startOfDay(new Date(s.sm2State.nextReview))<=t)}getOverdueCards(i,e=new Date){let t=this.addDays(this.startOfDay(e),-1);return i.filter(s=>this.startOfDay(new Date(s.sm2State.nextReview))<t)}estimateRetentionLevel(i){let{sm2State:e,reviewHistory:t}=i,{repetition:s,easeFactor:r,interval:n}=e;if(t.length===0)return"novice";let a=t.slice(-5),o=a.reduce((l,d)=>l+d.quality,0)/a.length;return s>=5&&r>=2.3&&n>=30&&o>=4?"mastered":s>=4&&r>=2&&n>=14&&o>=3.5?"advanced":s>=2&&r>=1.8&&o>=3?"intermediate":s>=1||t.length>=2?"learning":"novice"}optimizeReviewOrder(i){let e=new Date;return[...i].sort((t,s)=>{let r=new Date(t.sm2State.nextReview)<e,n=new Date(s.sm2State.nextReview)<e;if(r&&!n)return-1;if(!r&&n)return 1;let a=ie[t.retentionLevel],o=ie[s.retentionLevel];return a!==o?a-o:t.sm2State.easeFactor-s.sm2State.easeFactor})}addDays(i,e){let t=new Date(i);return t.setDate(t.getDate()+e),t}startOfDay(i){let e=new Date(i);return e.setHours(0,0,0,0),e}};function le(c,i,e){return{id:crypto.randomUUID(),name:e!=null?e:`Group ${c.length} notes`,noteIds:c,centroid:i,cohesion:0,createdAt:new Date}}function de(c){return c.length===0?0:c.reduce((e,t)=>e+t,0)/c.length}var $=class{async cluster(i,e){let{threshold:t,maxGroupSize:s}=e;if(i.length<2)return this.createEmptyResult(i.map(d=>d.noteId));let r=this.buildSimilarityMatrix(i),n=this.hierarchicalClustering(i,r,t,s),a=new Set(n.flatMap(d=>d.noteIds)),o=i.filter(d=>!a.has(d.noteId)).map(d=>d.noteId),l=this.createMetadata(i,n,t);return{groups:n,ungroupedNotes:o,metadata:l}}cosineSimilarity(i,e){if(i.length!==e.length)throw new Error("Vectors must have the same dimension");let t=0,s=0,r=0;for(let n=0;n<i.length;n++)t+=i[n]*e[n],s+=i[n]*i[n],r+=e[n]*e[n];return s===0||r===0?0:t/(Math.sqrt(s)*Math.sqrt(r))}findMostSimilar(i,e,t){return e.map(r=>({noteId:r.noteId,similarity:this.cosineSimilarity(i,r.vector)})).sort((r,n)=>n.similarity-r.similarity).slice(0,t)}buildSimilarityMatrix(i){let e=i.length,t=Array.from({length:e},()=>Array(e).fill(0));for(let s=0;s<e;s++){for(let r=s+1;r<e;r++){let n=this.cosineSimilarity(i[s].vector,i[r].vector);t[s][r]=n,t[r][s]=n}t[s][s]=1}return t}hierarchicalClustering(i,e,t,s){let r=i.length,n=i.map((l,d)=>new Set([d])),a=new Set(Array.from({length:r},(l,d)=>d));for(;a.size>1;){let l=-1,d=-1,u=-1,h=Array.from(a);for(let v=0;v<h.length;v++)for(let m=v+1;m<h.length;m++){let f=h[v],T=h[m];if(n[f].size+n[T].size>s)continue;let M=this.maxLinkSimilarity(n[f],n[T],e);M>l&&(l=M,d=f,u=T)}if(l<t||d===-1)break;n[u].forEach(v=>n[d].add(v)),a.delete(u)}let o=[];for(let l of a){let d=n[l];if(d.size<2)continue;let u=Array.from(d).map(R=>i[R].noteId),h=Array.from(d).map(R=>i[R].vector),v=this.calculateCentroid(h),m=[],f=Array.from(d);for(let R=0;R<f.length;R++)for(let W=R+1;W<f.length;W++)m.push(e[f[R]][f[W]]);let T=de(m),M=le(u,v);M.cohesion=T,o.push(M)}return o}maxLinkSimilarity(i,e,t){let s=-1;for(let r of i)for(let n of e)t[r][n]>s&&(s=t[r][n]);return s}calculateCentroid(i){if(i.length===0)return[];let e=i[0].length,t=Array(e).fill(0);for(let s of i)for(let r=0;r<e;r++)t[r]+=s[r];for(let s=0;s<e;s++)t[s]/=i.length;return t}createEmptyResult(i){return{groups:[],ungroupedNotes:i,metadata:{algorithm:"hierarchical",threshold:0,totalNotes:i.length,groupedNotes:0,averageCohesion:0,processedAt:new Date}}}createMetadata(i,e,t){let s=e.reduce((n,a)=>n+a.noteIds.length,0),r=e.length>0?e.reduce((n,a)=>n+a.cohesion,0)/e.length:0;return{algorithm:"hierarchical",threshold:t,totalNotes:i.length,groupedNotes:s,averageCohesion:r,processedAt:new Date}}};var ue=require("obsidian");var C=class{constructor(){this.apiKey="";this.model=""}setApiKey(i){this.apiKey=i}setModel(i){this.model=i}isAvailable(){return!!this.apiKey&&this.apiKey.length>0}get modelId(){return this.model}async makeRequest(i){try{return(await(0,ue.requestUrl)(i)).json}catch(e){throw this.normalizeError(e)}}isReasoningModel(){return L(this.model)}getMaxTokensParam(i){return this.isReasoningModel()?{max_completion_tokens:i}:{max_tokens:i}}normalizeError(i){if(console.error("[SRS Plugin] API Error:",i),i instanceof Error){let e=i.message.toLowerCase();return e.includes("429")||e.includes("rate")?{message:"API \uC694\uCCAD \uD55C\uB3C4 \uCD08\uACFC. \uC7A0\uC2DC \uD6C4 \uB2E4\uC2DC \uC2DC\uB3C4\uD574\uC8FC\uC138\uC694.",code:"RATE_LIMIT"}:e.includes("401")||e.includes("403")||e.includes("unauthorized")?{message:"API \uD0A4\uAC00 \uC720\uD6A8\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4. \uC124\uC815\uC5D0\uC11C \uD655\uC778\uD574\uC8FC\uC138\uC694.",code:"AUTH_ERROR"}:e.includes("timeout")||e.includes("etimedout")?{message:"\uC694\uCCAD \uC2DC\uAC04\uC774 \uCD08\uACFC\uB418\uC5C8\uC2B5\uB2C8\uB2E4. \uB124\uD2B8\uC6CC\uD06C\uB97C \uD655\uC778\uD574\uC8FC\uC138\uC694.",code:"TIMEOUT"}:e.includes("404")||e.includes("model")?{message:"\uC120\uD0DD\uD55C \uBAA8\uB378\uC744 \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.",code:"MODEL_NOT_FOUND"}:e.includes("402")||e.includes("quota")||e.includes("billing")?{message:"API \uC0AC\uC6A9\uB7C9 \uD55C\uB3C4\uC5D0 \uB3C4\uB2EC\uD588\uC2B5\uB2C8\uB2E4. \uACB0\uC81C \uC815\uBCF4\uB97C \uD655\uC778\uD574\uC8FC\uC138\uC694.",code:"QUOTA_EXCEEDED"}:e.includes("500")||e.includes("502")||e.includes("503")?{message:"API \uC11C\uBC84\uC5D0 \uBB38\uC81C\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4. \uC7A0\uC2DC \uD6C4 \uB2E4\uC2DC \uC2DC\uB3C4\uD574\uC8FC\uC138\uC694.",code:"SERVER_ERROR"}:{message:i.message,code:"UNKNOWN"}}return{message:"\uC54C \uC218 \uC5C6\uB294 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.",code:"UNKNOWN"}}handleError(i){return{success:!1,content:"",error:this.normalizeError(i).message}}extractSystemPrompt(i){let e=i.find(t=>t.role==="system");return e==null?void 0:e.content}filterNonSystemMessages(i){return i.filter(e=>e.role!=="system")}};var Te="https://api.anthropic.com/v1/messages",Me="2023-06-01",x=class extends C{constructor(){super(...arguments);this.name="Claude"}async generate(e,t){var s,r;if(!this.isAvailable())return{success:!1,content:"",error:"API \uD0A4\uAC00 \uC124\uC815\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4."};try{let n=this.extractSystemPrompt(e),a=this.formatMessages(e),o={model:this.model,messages:a,max_tokens:(s=t==null?void 0:t.maxTokens)!=null?s:4096};n&&(o.system=n),(t==null?void 0:t.temperature)!==void 0&&(o.temperature=t.temperature),(r=t==null?void 0:t.stopSequences)!=null&&r.length&&(o.stop_sequences=t.stopSequences);let l=await this.makeRequest({url:Te,method:"POST",headers:{"x-api-key":this.apiKey,"anthropic-version":Me,"content-type":"application/json"},body:JSON.stringify(o)});return this.parseResponse(l)}catch(n){return this.handleError(n)}}async testApiKey(e){let t=this.apiKey;this.apiKey=e;try{let s=await this.generate([{role:"user",content:"Hello"}],{maxTokens:10});return this.apiKey=t,s.success}catch(s){return this.apiKey=t,!1}}formatMessages(e){return this.filterNonSystemMessages(e).map(t=>({role:t.role,content:t.content}))}parseResponse(e){return{success:!0,content:e.content.filter(s=>s.type==="text").map(s=>s.text).join(""),usage:{promptTokens:e.usage.input_tokens,completionTokens:e.usage.output_tokens,totalTokens:e.usage.input_tokens+e.usage.output_tokens}}}};var Ae="https://api.openai.com/v1/chat/completions",E=class extends C{constructor(){super(...arguments);this.name="OpenAI"}async generate(e,t){var s,r,n;if(!this.isAvailable())return{success:!1,content:"",error:"API \uD0A4\uAC00 \uC124\uC815\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4."};try{let a=this.formatMessages(e),o=this.isReasoningModel(),l={model:this.model,messages:a};o?l.max_completion_tokens=(s=t==null?void 0:t.maxTokens)!=null?s:4096:(l.max_tokens=(r=t==null?void 0:t.maxTokens)!=null?r:4096,(t==null?void 0:t.temperature)!==void 0?l.temperature=t.temperature:l.temperature=.7),(n=t==null?void 0:t.stopSequences)!=null&&n.length&&(l.stop=t.stopSequences);let d=await this.makeRequest({url:Ae,method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(l)});return this.parseResponse(d)}catch(a){return this.handleError(a)}}async testApiKey(e){let t=this.apiKey,s=this.model;this.apiKey=e,this.model="gpt-4o-mini";try{let r=await this.generate([{role:"user",content:"Hello"}],{maxTokens:10});return this.apiKey=t,this.model=s,r.success}catch(r){return this.apiKey=t,this.model=s,!1}}formatMessages(e){return e.map(t=>({role:t.role,content:t.content}))}parseResponse(e){var s;return(s=e.choices)!=null&&s.length?{success:!0,content:e.choices[0].message.content,usage:{promptTokens:e.usage.prompt_tokens,completionTokens:e.usage.completion_tokens,totalTokens:e.usage.total_tokens}}:{success:!1,content:"",error:"No response from API"}}};var pe=require("obsidian"),D="srs-dashboard-view",H=class extends pe.ItemView{constructor(e,t){super(e);this.stats=null;this.refreshInterval=null;this.plugin=t}getViewType(){return D}getDisplayText(){return"SRS Dashboard"}getIcon(){return"brain"}async onOpen(){await this.loadStats(),this.render(),this.refreshInterval=setInterval(()=>{this.refresh()},300*1e3)}async onClose(){this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null)}async refresh(){await this.loadStats(),this.render()}async loadStats(){let t=await this.plugin.getReviewRepository().getAllCards(),s=this.plugin.getScheduler(),r=new Date,n=new Date(r.getFullYear(),r.getMonth(),r.getDate()),a=new Date(n);a.setDate(a.getDate()+7);let o=s.getDueCards(t),l=s.getOverdueCards(t),d=t.filter(m=>{let f=new Date(m.sm2State.nextReview);return f>=n&&f<=a}).length,u={novice:0,learning:0,intermediate:0,advanced:0,mastered:0};t.forEach(m=>{u[m.retentionLevel]++});let h=this.calculateRecentReviews(t),v=this.calculateStreak(t);this.stats={totalCards:t.length,dueToday:o.length,dueThisWeek:d,overdue:l.length,retentionDistribution:u,recentReviews:h,streakDays:v}}calculateRecentReviews(e){let t=new Map;for(let s=6;s>=0;s--){let r=new Date;r.setDate(r.getDate()-s);let n=r.toISOString().split("T")[0];t.set(n,0)}return e.forEach(s=>{s.reviewHistory.forEach(r=>{let n=new Date(r.reviewedAt).toISOString().split("T")[0];t.has(n)&&t.set(n,(t.get(n)||0)+1)})}),Array.from(t.entries()).map(([s,r])=>({date:s,count:r}))}calculateStreak(e){let t=new Set;e.forEach(n=>{n.reviewHistory.forEach(a=>{let o=new Date(a.reviewedAt).toISOString().split("T")[0];t.add(o)})});let s=0,r=new Date;for(let n=0;n<365;n++){let a=new Date(r);a.setDate(a.getDate()-n);let o=a.toISOString().split("T")[0];if(t.has(o))s++;else if(n>0)break}return s}render(){let e=this.containerEl.children[1];if(e.empty(),e.addClass("srs-dashboard"),!this.stats){e.createEl("div",{text:"\uB85C\uB529 \uC911...",cls:"srs-loading"});return}this.renderHeader(e),this.renderQuickStats(e),this.renderDueOverview(e),this.renderRetentionChart(e),this.renderRecentActivity(e),this.renderQuickActions(e)}renderHeader(e){let t=e.createEl("div",{cls:"srs-dashboard-header"});t.createEl("h4",{text:"\uBCF5\uC2B5 \uB300\uC2DC\uBCF4\uB4DC"});let s=t.createEl("button",{cls:"srs-refresh-btn",attr:{"aria-label":"\uC0C8\uB85C\uACE0\uCE68"}});s.innerHTML="\u{1F504}",s.onclick=()=>this.refresh()}renderQuickStats(e){if(!this.stats)return;let t=e.createEl("div",{cls:"srs-quick-stats"});if(this.stats.streakDays>0){let r=t.createEl("div",{cls:"srs-streak"});r.innerHTML=`\u{1F525} ${this.stats.streakDays}\uC77C \uC5F0\uC18D`}let s=t.createEl("div",{cls:"srs-stats-grid"});this.renderStatCard(s,{value:this.stats.totalCards.toString(),label:"\uC804\uCCB4 \uCE74\uB4DC",icon:"\u{1F4DA}"}),this.renderStatCard(s,{value:this.stats.dueToday.toString(),label:"\uC624\uB298 \uBCF5\uC2B5",icon:"\u{1F4C5}",highlight:this.stats.dueToday>0}),this.stats.overdue>0&&this.renderStatCard(s,{value:this.stats.overdue.toString(),label:"\uC9C0\uC5F0\uB428",icon:"\u26A0\uFE0F",warning:!0})}renderStatCard(e,t){let s=e.createEl("div",{cls:`srs-stat-card ${t.highlight?"is-highlight":""} ${t.warning?"is-warning":""}`});s.createEl("span",{text:t.icon,cls:"srs-stat-icon"}),s.createEl("div",{text:t.value,cls:"srs-stat-value"}),s.createEl("div",{text:t.label,cls:"srs-stat-label"})}renderDueOverview(e){if(!this.stats)return;let t=e.createEl("div",{cls:"srs-section"});t.createEl("h5",{text:"\uBCF5\uC2B5 \uC77C\uC815"});let s=t.createEl("div",{cls:"srs-due-list"}),r=[{label:"\uC624\uB298",count:this.stats.dueToday,cls:"srs-due-today"},{label:"\uC774\uBC88 \uC8FC",count:this.stats.dueThisWeek,cls:"srs-due-week"}];this.stats.overdue>0&&r.unshift({label:"\uC9C0\uC5F0\uB428",count:this.stats.overdue,cls:"srs-due-overdue"}),r.forEach(n=>{let a=s.createEl("div",{cls:`srs-due-item ${n.cls}`});a.createEl("span",{text:n.label}),a.createEl("span",{text:`${n.count}\uAC1C`,cls:"srs-due-count"})})}renderRetentionChart(e){if(!this.stats)return;let t=e.createEl("div",{cls:"srs-section"});t.createEl("h5",{text:"\uC815\uCC29\uB3C4 \uBD84\uD3EC"});let s=t.createEl("div",{cls:"srs-retention-chart"}),r=[{level:"novice",emoji:"\u{1F331}",name:"\uCD08\uBCF4"},{level:"learning",emoji:"\u{1F4DA}",name:"\uD559\uC2B5\uC911"},{level:"intermediate",emoji:"\u{1F504}",name:"\uC911\uAC04"},{level:"advanced",emoji:"\u2B50",name:"\uACE0\uAE09"},{level:"mastered",emoji:"\u{1F3C6}",name:"\uB9C8\uC2A4\uD130"}],n=this.stats.totalCards||1;r.forEach(({level:a,emoji:o,name:l})=>{let d=this.stats.retentionDistribution[a],u=Math.round(d/n*100),h=s.createEl("div",{cls:"srs-retention-bar"});h.createEl("div",{cls:"srs-bar-label"}).innerHTML=`
        <span class="srs-bar-emoji">${o}</span>
        <span class="srs-bar-name">${l}</span>
      `;let m=h.createEl("div",{cls:"srs-bar-track"}).createEl("div",{cls:`srs-bar-fill srs-level-${a}`});m.style.width=`${u}%`,h.createEl("span",{text:`${d}`,cls:"srs-bar-count"})})}renderRecentActivity(e){if(!this.stats)return;let t=e.createEl("div",{cls:"srs-section"});t.createEl("h5",{text:"\uCD5C\uADFC 7\uC77C \uD65C\uB3D9"});let s=t.createEl("div",{cls:"srs-activity-chart"}),r=Math.max(...this.stats.recentReviews.map(n=>n.count),1);this.stats.recentReviews.forEach(n=>{let a=s.createEl("div",{cls:"srs-activity-day"}),o=n.count/r*60,l=a.createEl("div",{cls:"srs-activity-bar"});l.style.height=`${Math.max(o,4)}px`,n.count>0&&l.addClass("is-active");let d=new Date(n.date),u=["\uC77C","\uC6D4","\uD654","\uC218","\uBAA9","\uAE08","\uD1A0"];a.createEl("span",{text:u[d.getDay()],cls:"srs-activity-label"})})}renderQuickActions(e){let s=e.createEl("div",{cls:"srs-section srs-actions"}).createEl("button",{cls:"mod-cta srs-action-btn"});s.innerHTML="\u{1F4DD} \uBCF5\uC2B5 \uC2DC\uC791",s.onclick=()=>{this.plugin.startReviewSession()}}};var w=require("obsidian");var b={COMPLETE_BLACKOUT:0,WRONG_REMEMBERED:1,WRONG_EASY:2,CORRECT_DIFFICULT:3,CORRECT_HESITATION:4,PERFECT:5};var G=class extends w.Modal{constructor(e,t){super(e);this.cards=[];this.currentIndex=0;this.reviewMode="quick";this.isAnswerShown=!1;this.startTime=0;this.plugin=t}async onOpen(){let{contentEl:e}=this;if(e.addClass("srs-review-modal"),await this.loadDueCards(),this.cards.length===0){this.renderNoCards();return}this.startTime=Date.now(),this.renderCard()}onClose(){let{contentEl:e}=this;e.empty()}async loadDueCards(){let{reviewCards:e,newCardsToIntroduce:t}=await this.plugin.selectTodayReviewCards();this.cards=[...e];for(let s of t)if(!this.cards.find(r=>r.noteId===s.noteId)){let r=await this.plugin.getReviewRepository().getCard(s.noteId);r&&this.cards.push(r)}this.cards.sort((s,r)=>{let n={novice:0,learning:1,intermediate:2,advanced:3,mastered:4};return n[s.retentionLevel]-n[r.retentionLevel]})}renderNoCards(){let{contentEl:e}=this;e.empty(),e.createEl("div",{cls:"srs-review-complete"}).innerHTML=`
      <h2>\u{1F389} \uBCF5\uC2B5 \uC644\uB8CC!</h2>
      <p>\uC624\uB298 \uBCF5\uC2B5\uD560 \uB178\uD2B8\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>
    `;let t=e.createEl("button",{text:"\uB2EB\uAE30",cls:"mod-cta"});t.onclick=()=>this.close()}renderCard(){let{contentEl:e}=this;e.empty();let t=this.cards[this.currentIndex];if(!t){this.renderSessionComplete();return}this.renderProgress(e),this.renderModeToggle(e),this.renderCardContent(e,t),this.isAnswerShown?this.renderQualityButtons(e):this.renderShowAnswerButton(e)}renderProgress(e){let t=e.createEl("div",{cls:"srs-review-progress"}),s=this.currentIndex+1,r=this.cards.length,n=Math.round(this.currentIndex/r*100),o=this.plugin.getSessionManager().getDailyQueue(),l=o.focusSession,d="";if(l&&l.status==="active"){let u=l.remainingNoteIds.length;d=`<div class="srs-session-info">\u{1F4CC} ${l.clusterLabel} (${u}\uAC1C \uB0A8\uC74C)</div>`}t.innerHTML=`
      ${d}
      <div class="srs-progress-text">${s} / ${r}</div>
      <div class="srs-progress-bar">
        <div class="srs-progress-fill" style="width: ${n}%"></div>
      </div>
      <div class="srs-daily-info">\uC624\uB298 \uBCF5\uC2B5: ${o.reviewedCount}/${o.dailyLimit} | \uC2E0\uADDC: ${o.newCardsIntroduced}/${o.newCardsLimit}</div>
    `}renderModeToggle(e){let t=e.createEl("div",{cls:"srs-mode-toggle"}),s=t.createEl("button",{text:"\u26A1 \uBE60\uB978 \uBCF5\uC2B5",cls:this.reviewMode==="quick"?"is-active":""});s.onclick=()=>{this.reviewMode="quick",this.renderCard()};let r=t.createEl("button",{text:"\u{1F50D} \uAE4A\uC740 \uBCF5\uC2B5",cls:this.reviewMode==="deep"?"is-active":""});if(r.onclick=()=>{this.reviewMode="deep",this.renderCard()},this.plugin.settings.quiz.enabled){let n=t.createEl("button",{text:"\u{1F4DD} \uD034\uC988",cls:this.reviewMode==="quiz"?"is-active":""});n.onclick=()=>{this.reviewMode="quiz",this.startQuiz()}}}async renderCardContent(e,t){let s=e.createEl("div",{cls:"srs-card"}),r=s.createEl("div",{cls:"srs-card-header"});r.createEl("h3",{text:t.noteTitle}),this.renderRetentionBadge(r,t.retentionLevel);let n=s.createEl("div",{cls:"srs-card-content"});if(this.reviewMode==="quick"?n.createEl("p",{text:"\uC774 \uB178\uD2B8\uB97C \uAE30\uC5B5\uD558\uC2DC\uB098\uC694?"}):await this.renderNotePreview(n,t),this.isAnswerShown){let a=s.createEl("div",{cls:"srs-card-answer"});a.createEl("hr");let o=a.createEl("a",{text:"\u{1F4C4} \uB178\uD2B8 \uC5F4\uAE30",cls:"srs-note-link"});o.onclick=async()=>{let l=this.app.vault.getAbstractFileByPath(t.notePath);l instanceof w.TFile&&await this.app.workspace.getLeaf().openFile(l)},this.renderSM2Info(a,t)}}renderRetentionBadge(e,t){let r={novice:{text:"\u{1F331} \uCD08\uBCF4",cls:"srs-badge-novice"},learning:{text:"\u{1F4DA} \uD559\uC2B5\uC911",cls:"srs-badge-learning"},intermediate:{text:"\u{1F504} \uC911\uAC04",cls:"srs-badge-intermediate"},advanced:{text:"\u2B50 \uACE0\uAE09",cls:"srs-badge-advanced"},mastered:{text:"\u{1F3C6} \uB9C8\uC2A4\uD130",cls:"srs-badge-mastered"}}[t];e.createEl("span",{text:r.text,cls:`srs-retention-badge ${r.cls}`})}async renderNotePreview(e,t){try{let s=this.app.vault.getAbstractFileByPath(t.notePath);if(!(s instanceof w.TFile))return;let n=(await this.app.vault.cachedRead(s)).replace(/^---[\s\S]*?---\n*/,""),a=n.slice(0,500)+(n.length>500?"...":"");await w.MarkdownRenderer.render(this.app,a,e,t.notePath,this.plugin)}catch(s){e.createEl("p",{text:"\uB178\uD2B8 \uB0B4\uC6A9\uC744 \uBD88\uB7EC\uC62C \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."})}}renderSM2Info(e,t){let s=e.createEl("div",{cls:"srs-sm2-info"}),{sm2State:r}=t;s.innerHTML=`
      <div class="srs-sm2-stat">
        <span>\uC5F0\uC18D \uC131\uACF5:</span> <strong>${r.repetition}\uD68C</strong>
      </div>
      <div class="srs-sm2-stat">
        <span>\uD604\uC7AC \uAC04\uACA9:</span> <strong>${r.interval}\uC77C</strong>
      </div>
      <div class="srs-sm2-stat">
        <span>\uB09C\uC774\uB3C4 \uACC4\uC218:</span> <strong>${r.easeFactor.toFixed(2)}</strong>
      </div>
    `}renderShowAnswerButton(e){let s=e.createEl("div",{cls:"srs-button-area"}).createEl("button",{text:"\uB2F5\uBCC0 \uBCF4\uAE30",cls:"mod-cta srs-show-answer-btn"});s.onclick=()=>{this.isAnswerShown=!0,this.renderCard()}}renderQualityButtons(e){let t=e.createEl("div",{cls:"srs-quality-buttons"});[{q:b.COMPLETE_BLACKOUT,text:"\u{1F635} \uC804\uD600 \uBAA8\uB984",cls:"srs-q-0"},{q:b.WRONG_REMEMBERED,text:"\u{1F61F} \uD2C0\uB9BC",cls:"srs-q-1"},{q:b.WRONG_EASY,text:"\u{1F610} \uC5B4\uB824\uC6C0",cls:"srs-q-2"},{q:b.CORRECT_DIFFICULT,text:"\u{1F914} \uD798\uB4E4\uAC8C \uB9DE\uCDA4",cls:"srs-q-3"},{q:b.CORRECT_HESITATION,text:"\u{1F60A} \uC57D\uAC04 \uACE0\uBBFC",cls:"srs-q-4"},{q:b.PERFECT,text:"\u{1F389} \uC644\uBCBD!",cls:"srs-q-5"}].forEach(({q:r,text:n,cls:a})=>{let o=t.createEl("button",{text:n,cls:a});o.onclick=()=>this.handleQualityResponse(r)})}async handleQualityResponse(e){let t=this.cards[this.currentIndex];if(!t)return;let s=this.plugin.getScheduler(),r=s.calculateNext(t,e),n={...t,sm2State:r},a=s.estimateRetentionLevel(n),o=t.sm2State.repetition===0;t.reviewHistory.push({reviewedAt:new Date,quality:e,mode:this.reviewMode}),t.sm2State=r,t.retentionLevel=a,t.lastModified=new Date,await this.plugin.getReviewRepository().saveCard(t),this.plugin.getSessionManager().markReviewed(t.noteId,o),await this.plugin.saveSessionData(),this.currentIndex++,this.isAnswerShown=!1,this.startTime=Date.now(),this.currentIndex>=this.cards.length?this.renderSessionComplete():this.renderCard()}renderSessionComplete(){let{contentEl:e}=this;e.empty();let t=this.currentIndex;e.createEl("div",{cls:"srs-session-complete"}).innerHTML=`
      <h2>\u{1F389} \uBCF5\uC2B5 \uC138\uC158 \uC644\uB8CC!</h2>
      <div class="srs-session-stats">
        <div class="srs-stat">
          <span class="srs-stat-value">${t}</span>
          <span class="srs-stat-label">\uBCF5\uC2B5 \uC644\uB8CC</span>
        </div>
      </div>
      <p>\uC218\uACE0\uD558\uC168\uC2B5\uB2C8\uB2E4!</p>
    `;let s=e.createEl("button",{text:"\uB2EB\uAE30",cls:"mod-cta"});s.onclick=()=>{this.plugin.updateBadge(),this.close()}}startQuiz(){let e=this.cards[this.currentIndex];if(!e)return;if(!(this.app.vault.getAbstractFileByPath(e.notePath)instanceof w.TFile)){new w.Notice("\uB178\uD2B8\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.");return}new w.Notice("\uD034\uC988 \uAE30\uB2A5\uC740 \uBCC4\uB3C4 \uBAA8\uB2EC\uC5D0\uC11C \uC81C\uACF5\uB429\uB2C8\uB2E4.")}};var I=require("obsidian");function he(c){if(c.length===0)return 0;let i=c.filter(e=>e.isCorrect).length;return Math.round(i/c.length*100)}function me(c){return c>=90?5:c>=75?4:c>=60?3:c>=40?2:c>=20?1:0}var Pe=`\uB2F9\uC2E0\uC740 \uD559\uC2B5 \uD6A8\uACFC\uB97C \uADF9\uB300\uD654\uD558\uB294 \uD034\uC988 \uC0DD\uC131 \uC804\uBB38\uAC00\uC785\uB2C8\uB2E4.

\uC8FC\uC5B4\uC9C4 \uB178\uD2B8 \uB0B4\uC6A9\uC744 \uBD84\uC11D\uD558\uC5EC \uD559\uC2B5\uC790\uC758 \uC774\uD574\uB3C4\uB97C \uD14C\uC2A4\uD2B8\uD558\uB294 \uACE0\uD488\uC9C8 \uD034\uC988\uB97C \uC0DD\uC131\uD569\uB2C8\uB2E4.

\uADDC\uCE59:
1. \uC9C8\uBB38\uC740 \uB178\uD2B8\uC758 \uD575\uC2EC \uAC1C\uB150\uC744 \uC815\uD655\uD788 \uD14C\uC2A4\uD2B8\uD574\uC57C \uD569\uB2C8\uB2E4
2. \uB2F5\uBCC0\uC740 \uB178\uD2B8 \uB0B4\uC6A9\uC5D0\uC11C \uC9C1\uC811 \uB3C4\uCD9C \uAC00\uB2A5\uD574\uC57C \uD569\uB2C8\uB2E4
3. \uAC1D\uAD00\uC2DD\uC758 \uACBD\uC6B0 \uC624\uB2F5\uB3C4 \uADF8\uB7F4\uB4EF\uD574\uC57C \uD569\uB2C8\uB2E4
4. \uC124\uBA85\uC740 \uD559\uC2B5\uC5D0 \uB3C4\uC6C0\uC774 \uB418\uC5B4\uC57C \uD569\uB2C8\uB2E4
5. JSON \uD615\uC2DD\uC73C\uB85C\uB9CC \uC751\uB2F5\uD558\uC138\uC694`,Le=`You are an expert quiz generator focused on maximizing learning effectiveness.

Analyze the given note content and create high-quality quizzes to test learner comprehension.

Rules:
1. Questions must accurately test core concepts from the note
2. Answers must be directly derivable from the note content
3. For multiple choice, wrong options should be plausible
4. Explanations should aid learning
5. Respond only in JSON format`;function ge(c,i){var n;let e=i.language==="ko",t=e?ke(i.types):ze(i.types),s=e?Ne(i.difficulty):qe(i.difficulty),r=(n=i.focusKeywords)!=null&&n.length?e?`
\uD2B9\uD788 \uB2E4\uC74C \uD0A4\uC6CC\uB4DC\uC5D0 \uC9D1\uC911: ${i.focusKeywords.join(", ")}`:`
Focus especially on these keywords: ${i.focusKeywords.join(", ")}`:"";return e?`\uB2E4\uC74C \uB178\uD2B8 \uB0B4\uC6A9\uC744 \uAE30\uBC18\uC73C\uB85C ${i.questionCount}\uAC1C\uC758 \uD034\uC988 \uC9C8\uBB38\uC744 \uC0DD\uC131\uD558\uC138\uC694.

## \uB178\uD2B8 \uC81C\uBAA9
${i.noteTitle||"(\uC81C\uBAA9 \uC5C6\uC74C)"}

## \uB178\uD2B8 \uB0B4\uC6A9
${c}

## \uC694\uAD6C\uC0AC\uD56D
- \uC9C8\uBB38 \uC218: ${i.questionCount}\uAC1C
- \uD5C8\uC6A9 \uC720\uD615: ${t}
${s}${r}

## \uC751\uB2F5 \uD615\uC2DD (JSON)
{
  "questions": [
    {
      "type": "multiple_choice" | "true_false" | "open_ended" | "fill_blank",
      "question": "\uC9C8\uBB38 \uB0B4\uC6A9",
      "options": ["\uC120\uD0DD\uC9C01", "\uC120\uD0DD\uC9C02", ...],  // \uAC1D\uAD00\uC2DD\uB9CC
      "correctAnswer": "\uC815\uB2F5",
      "explanation": "\uC124\uBA85",
      "difficulty": "easy" | "medium" | "hard"
    }
  ]
}`:`Generate ${i.questionCount} quiz questions based on the following note content.

## Note Title
${i.noteTitle||"(Untitled)"}

## Note Content
${c}

## Requirements
- Question count: ${i.questionCount}
- Allowed types: ${t}
${s}${r}

## Response Format (JSON)
{
  "questions": [
    {
      "type": "multiple_choice" | "true_false" | "open_ended" | "fill_blank",
      "question": "Question text",
      "options": ["Option1", "Option2", ...],  // multiple choice only
      "correctAnswer": "Correct answer",
      "explanation": "Explanation",
      "difficulty": "easy" | "medium" | "hard"
    }
  ]
}`}function ke(c){let i={multiple_choice:"\uAC1D\uAD00\uC2DD (4\uC9C0\uC120\uB2E4)",true_false:"\uCC38/\uAC70\uC9D3",open_ended:"\uC11C\uC220\uD615",fill_blank:"\uBE48\uCE78 \uCC44\uC6B0\uAE30"};return c.map(e=>i[e]).join(", ")}function ze(c){let i={multiple_choice:"Multiple Choice (4 options)",true_false:"True/False",open_ended:"Open-ended",fill_blank:"Fill in the blank"};return c.map(e=>i[e]).join(", ")}function Ne(c){return c==="mixed"?"- \uB09C\uC774\uB3C4: \uC26C\uC6C0/\uC911\uAC04/\uC5B4\uB824\uC6C0\uC744 \uACE8\uACE0\uB8E8 \uC11E\uC5B4\uC11C":`- \uB09C\uC774\uB3C4: ${{easy:"\uC26C\uC6C0 (\uAE30\uBCF8 \uAC1C\uB150 \uD655\uC778)",medium:"\uC911\uAC04 (\uC801\uC6A9 \uBC0F \uBD84\uC11D)",hard:"\uC5B4\uB824\uC6C0 (\uC885\uD569 \uBC0F \uD3C9\uAC00)"}[c]}`}function qe(c){return c==="mixed"?"- Difficulty: Mix of easy/medium/hard":`- Difficulty: ${{easy:"Easy (basic concept verification)",medium:"Medium (application and analysis)",hard:"Hard (synthesis and evaluation)"}[c]}`}function ve(c){try{let i=c,e=c.match(/```(?:json)?\s*([\s\S]*?)```/);if(e)i=e[1].trim();else{let r=c.match(/\{[\s\S]*\}/);r&&(i=r[0])}let t=JSON.parse(i);if(!t.questions||!Array.isArray(t.questions))return console.error("[SRS] Invalid quiz response: missing questions array"),null;let s=t.questions.filter(r=>!(!r.question||!r.correctAnswer||!r.type||r.type==="multiple_choice"&&(!r.options||r.options.length<2)));return s.forEach(r=>{["easy","medium","hard"].includes(r.difficulty)||(r.difficulty="medium")}),{questions:s}}catch(i){return console.error("[SRS] Failed to parse quiz response:",i),null}}function fe(c){return c==="ko"?Pe:Le}var B=class{constructor(i){this.provider=i}async generate(i,e){let t=fe(e.language),s=ge(i,e),r=await this.provider.generate([{role:"system",content:t},{role:"user",content:s}],{maxTokens:4096,temperature:.7});if(!r.success)throw new Error(`Quiz generation failed: ${r.error}`);let n=ve(r.content);if(!n||n.questions.length===0)throw new Error("Failed to parse quiz response from LLM");let a=n.questions.map((o,l)=>({id:this.generateQuestionId(e.noteId,l),type:o.type,question:o.question,options:o.options,correctAnswer:o.correctAnswer,explanation:o.explanation,difficulty:o.difficulty}));return{noteId:e.noteId,questions:a,generatedAt:new Date,model:this.provider.name,noteTitle:e.noteTitle}}validateAnswer(i,e){let t=e.trim().toLowerCase(),s=i.correctAnswer.trim().toLowerCase();switch(i.type){case"multiple_choice":case"true_false":return this.validateExactMatch(t,s,i);case"fill_blank":return this.validateFillBlank(t,s,i);case"open_ended":return this.validateOpenEnded(t,s,i);default:return{isCorrect:!1,feedback:"Unknown question type",correctAnswer:i.correctAnswer}}}generateQuestionId(i,e){let t=Date.now().toString(36);return`${i.substring(0,8)}-q${e}-${t}`}validateExactMatch(i,e,t){let s=i===e;return{isCorrect:s,feedback:s?this.getCorrectFeedback(t):this.getIncorrectFeedback(t),correctAnswer:t.correctAnswer}}validateFillBlank(i,e,t){let s=this.calculateSimpleSimilarity(i,e),r=i===e||s>=.95;return{isCorrect:r,similarity:s,feedback:r?this.getCorrectFeedback(t):this.getIncorrectFeedback(t),correctAnswer:t.correctAnswer}}validateOpenEnded(i,e,t){let s=this.extractKeywords(e),r=this.extractKeywords(i),n=s.filter(l=>r.includes(l)).length,a=s.length>0?n/s.length:0,o=a>=.5;return{isCorrect:o,similarity:a,feedback:o?this.getCorrectFeedback(t):this.getPartialFeedback(t,a),correctAnswer:t.correctAnswer}}calculateSimpleSimilarity(i,e){if(i===e)return 1;if(i.length===0||e.length===0)return 0;let t=[];for(let r=0;r<=e.length;r++)t[r]=[r];for(let r=0;r<=i.length;r++)t[0][r]=r;for(let r=1;r<=e.length;r++)for(let n=1;n<=i.length;n++)e.charAt(r-1)===i.charAt(n-1)?t[r][n]=t[r-1][n-1]:t[r][n]=Math.min(t[r-1][n-1]+1,t[r][n-1]+1,t[r-1][n]+1);let s=Math.max(i.length,e.length);return 1-t[e.length][i.length]/s}extractKeywords(i){let e=new Set(["a","an","the","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","shall","to","of","in","for","on","with","at","by","from","and","or","but","if","then","else","when","where","\uC740","\uB294","\uC774","\uAC00","\uC744","\uB97C","\uC758","\uC5D0","\uC640","\uACFC","\uB3C4","\uB85C","\uC73C\uB85C","\uC5D0\uC11C","\uAE4C\uC9C0","\uBD80\uD130","\uCC98\uB7FC","\uAC19\uC774"]);return i.split(/\s+/).map(t=>t.replace(/[^\w-]/g,"").toLowerCase()).filter(t=>t.length>1&&!e.has(t))}getCorrectFeedback(i){return i.explanation?`\uC815\uB2F5\uC785\uB2C8\uB2E4! ${i.explanation}`:"\uC815\uB2F5\uC785\uB2C8\uB2E4!"}getIncorrectFeedback(i){return i.explanation?`\uD2C0\uB838\uC2B5\uB2C8\uB2E4. ${i.explanation}`:`\uD2C0\uB838\uC2B5\uB2C8\uB2E4. \uC815\uB2F5\uC740 "${i.correctAnswer}"\uC785\uB2C8\uB2E4.`}getPartialFeedback(i,e){let t=Math.round(e*100);return e>=.3?`\uC77C\uBD80 \uB9DE\uC558\uC2B5\uB2C8\uB2E4 (${t}%). \uC815\uB2F5: ${i.correctAnswer}`:this.getIncorrectFeedback(i)}};var V=class extends I.Modal{constructor(e,t,s){super(e);this.state="loading";this.quiz=null;this.quizGenerator=null;this.currentIndex=0;this.answers=[];this.questionStartTime=0;this.sessionStartTime=0;this.currentAnswer="";this.currentResult=null;this.errorMessage="";this.plugin=t,this.file=s}async onOpen(){let{contentEl:e}=this;if(e.addClass("srs-quiz-modal"),this.initializeQuizGenerator(),!this.quizGenerator){this.state="error",this.errorMessage="AI \uC11C\uBE44\uC2A4\uAC00 \uC124\uC815\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4. \uC124\uC815\uC5D0\uC11C API \uD0A4\uB97C \uC785\uB825\uD574\uC8FC\uC138\uC694.",this.render();return}this.sessionStartTime=Date.now(),this.render(),await this.generateQuiz()}onClose(){let{contentEl:e}=this;e.empty()}initializeQuizGenerator(){let e=this.plugin.settings,t=e.ai.apiKeys[e.ai.provider];if(!t)return;let s;switch(e.ai.provider){case"claude":s=new x,s.setApiKey(t),s.setModel(e.ai.model);break;case"openai":s=new E,s.setApiKey(t),s.setModel(e.ai.model);break;default:return}this.quizGenerator=new B(s)}async generateQuiz(){try{let t=(await this.app.vault.cachedRead(this.file)).replace(/^---[\s\S]*?---\n*/,""),s=this.plugin.settings;this.quiz=await this.quizGenerator.generate(t,{noteId:te(this.file.path),noteTitle:this.file.basename,questionCount:s.quiz.questionCount,types:s.quiz.types,difficulty:s.quiz.difficulty,language:s.quiz.language}),this.state="ready",this.render()}catch(e){console.error("[SRS] Quiz generation failed:",e),this.state="error",this.errorMessage=e instanceof Error?e.message:"\uD034\uC988 \uC0DD\uC131 \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.",this.render()}}render(){let{contentEl:e}=this;switch(e.empty(),this.state){case"loading":this.renderLoading();break;case"ready":this.renderReady();break;case"question":this.renderQuestion();break;case"feedback":this.renderFeedback();break;case"result":this.renderResult();break;case"error":this.renderError();break}}renderLoading(){let{contentEl:e}=this,t=e.createEl("div",{cls:"srs-quiz-loading"});t.createEl("div",{cls:"srs-loading-spinner"}),t.createEl("h3",{text:"\uD034\uC988 \uC0DD\uC131 \uC911..."}),t.createEl("p",{text:`"${this.file.basename}" \uB178\uD2B8\uB97C \uBD84\uC11D\uD558\uACE0 \uC788\uC2B5\uB2C8\uB2E4.`})}renderReady(){let{contentEl:e}=this;if(!this.quiz)return;let t=e.createEl("div",{cls:"srs-quiz-ready"});t.createEl("h2",{text:"\uD034\uC988 \uC900\uBE44 \uC644\uB8CC!"}),t.createEl("p",{text:`"${this.file.basename}"`});let s=t.createEl("div",{cls:"srs-quiz-stats"});s.createEl("div",{cls:"srs-stat"}).innerHTML=`
      <span class="srs-stat-value">${this.quiz.questions.length}</span>
      <span class="srs-stat-label">\uBB38\uC81C \uC218</span>
    `;let r=this.quiz.questions.reduce((d,u)=>(d[u.type]=(d[u.type]||0)+1,d),{}),n={multiple_choice:"\uAC1D\uAD00\uC2DD",true_false:"\uCC38/\uAC70\uC9D3",open_ended:"\uC11C\uC220\uD615",fill_blank:"\uBE48\uCE78"},a=Object.entries(r).map(([d,u])=>`${n[d]||d}: ${u}\uAC1C`).join(", ");t.createEl("p",{text:a,cls:"srs-quiz-types"});let o=t.createEl("button",{text:"\uC2DC\uC791\uD558\uAE30",cls:"mod-cta srs-start-btn"});o.onclick=()=>this.startQuiz();let l=t.createEl("button",{text:"\uCDE8\uC18C",cls:"srs-cancel-btn"});l.onclick=()=>this.close()}renderQuestion(){let{contentEl:e}=this;if(!this.quiz)return;let t=this.quiz.questions[this.currentIndex];if(!t)return;this.renderProgress(e);let s=e.createEl("div",{cls:"srs-quiz-card"}),r=s.createEl("div",{cls:"srs-quiz-header"});this.renderQuestionTypeBadge(r,t),this.renderDifficultyBadge(r,t),s.createEl("div",{cls:"srs-quiz-question",text:t.question});let n=s.createEl("div",{cls:"srs-quiz-input-area"});this.renderAnswerInput(n,t);let a=e.createEl("div",{cls:"srs-button-area"}),o=a.createEl("button",{text:"\uC81C\uCD9C",cls:"mod-cta srs-submit-btn"});o.onclick=()=>this.submitAnswer();let l=a.createEl("button",{text:"\uAC74\uB108\uB6F0\uAE30",cls:"srs-skip-btn"});l.onclick=()=>this.skipQuestion()}renderProgress(e){if(!this.quiz)return;let t=e.createEl("div",{cls:"srs-quiz-progress"}),s=this.currentIndex+1,r=this.quiz.questions.length,n=Math.round(this.currentIndex/r*100);t.innerHTML=`
      <div class="srs-progress-text">${s} / ${r}</div>
      <div class="srs-progress-bar">
        <div class="srs-progress-fill" style="width: ${n}%"></div>
      </div>
    `}renderQuestionTypeBadge(e,t){let s={multiple_choice:"\uAC1D\uAD00\uC2DD",true_false:"\uCC38/\uAC70\uC9D3",open_ended:"\uC11C\uC220\uD615",fill_blank:"\uBE48\uCE78 \uCC44\uC6B0\uAE30"};e.createEl("span",{text:s[t.type]||t.type,cls:`srs-question-type srs-type-${t.type}`})}renderDifficultyBadge(e,t){let s={easy:"\uC26C\uC6C0",medium:"\uBCF4\uD1B5",hard:"\uC5B4\uB824\uC6C0"};e.createEl("span",{text:s[t.difficulty]||t.difficulty,cls:`srs-difficulty srs-diff-${t.difficulty}`})}renderAnswerInput(e,t){switch(this.currentAnswer="",t.type){case"multiple_choice":this.renderMultipleChoice(e,t);break;case"true_false":this.renderTrueFalse(e);break;case"open_ended":this.renderOpenEnded(e);break;case"fill_blank":this.renderFillBlank(e);break}}renderMultipleChoice(e,t){if(!t.options)return;let s=e.createEl("div",{cls:"srs-options"});t.options.forEach((r,n)=>{let a=s.createEl("label",{cls:"srs-option"}),o=a.createEl("input",{type:"radio",attr:{name:"quiz-option",value:r}});o.onchange=()=>{this.currentAnswer=r,s.querySelectorAll(".srs-option").forEach(l=>{l.removeClass("is-selected")}),a.addClass("is-selected")},a.createEl("span",{text:`${String.fromCharCode(65+n)}. ${r}`})})}renderTrueFalse(e){let t=e.createEl("div",{cls:"srs-tf-options"}),s=t.createEl("button",{text:"\u2B55 \uCC38",cls:"srs-tf-btn"});s.onclick=()=>{this.currentAnswer="\uCC38",t.querySelectorAll(".srs-tf-btn").forEach(n=>n.removeClass("is-selected")),s.addClass("is-selected")};let r=t.createEl("button",{text:"\u274C \uAC70\uC9D3",cls:"srs-tf-btn"});r.onclick=()=>{this.currentAnswer="\uAC70\uC9D3",t.querySelectorAll(".srs-tf-btn").forEach(n=>n.removeClass("is-selected")),r.addClass("is-selected")}}renderOpenEnded(e){let t=e.createEl("textarea",{cls:"srs-answer-textarea",attr:{placeholder:"\uB2F5\uBCC0\uC744 \uC785\uB825\uD558\uC138\uC694...",rows:"4"}});t.oninput=()=>{this.currentAnswer=t.value}}renderFillBlank(e){let t=e.createEl("input",{type:"text",cls:"srs-answer-input",attr:{placeholder:"\uBE48\uCE78\uC5D0 \uB4E4\uC5B4\uAC08 \uB0B4\uC6A9\uC744 \uC785\uB825\uD558\uC138\uC694..."}});t.oninput=()=>{this.currentAnswer=t.value}}renderFeedback(){let{contentEl:e}=this;if(!this.quiz||!this.currentResult)return;let t=this.quiz.questions[this.currentIndex];if(!t)return;this.renderProgress(e);let s=e.createEl("div",{cls:`srs-feedback-card ${this.currentResult.isCorrect?"is-correct":"is-incorrect"}`}),r=s.createEl("div",{cls:"srs-feedback-icon"});if(r.innerHTML=this.currentResult.isCorrect?"\u2705":"\u274C",s.createEl("div",{cls:"srs-quiz-question srs-feedback-question",text:t.question}),s.createEl("div",{cls:"srs-your-answer"}).innerHTML=`
      <strong>\uB2F9\uC2E0\uC758 \uB2F5:</strong> ${this.currentAnswer||"(\uAC74\uB108\uB700)"}
    `,this.currentResult.isCorrect||(s.createEl("div",{cls:"srs-correct-answer"}).innerHTML=`
        <strong>\uC815\uB2F5:</strong> ${t.correctAnswer}
      `),s.createEl("div",{cls:"srs-feedback-text",text:this.currentResult.feedback}),this.currentResult.similarity!==void 0){let o=Math.round(this.currentResult.similarity*100);s.createEl("div",{cls:"srs-similarity",text:`\uC720\uC0AC\uB3C4: ${o}%`})}let a=e.createEl("div",{cls:"srs-button-area"}).createEl("button",{text:this.currentIndex<this.quiz.questions.length-1?"\uB2E4\uC74C \uBB38\uC81C":"\uACB0\uACFC \uBCF4\uAE30",cls:"mod-cta"});a.onclick=()=>this.nextQuestion()}renderResult(){let{contentEl:e}=this;if(!this.quiz)return;let t=he(this.answers),s=me(t),r=Math.floor((Date.now()-this.sessionStartTime)/1e3),n=e.createEl("div",{cls:"srs-quiz-result"}),a=n.createEl("div",{cls:"srs-result-score"});a.createEl("div",{cls:"srs-score-value",text:`${t}\uC810`}),a.createEl("div",{cls:"srs-score-label",text:this.getScoreLabel(t)});let o=n.createEl("div",{cls:"srs-result-stats"}),l=this.answers.filter(m=>m.isCorrect).length,d=this.quiz.questions.length;o.innerHTML=`
      <div class="srs-stat">
        <span class="srs-stat-value">${l}/${d}</span>
        <span class="srs-stat-label">\uC815\uB2F5</span>
      </div>
      <div class="srs-stat">
        <span class="srs-stat-value">${this.formatTime(r)}</span>
        <span class="srs-stat-label">\uC18C\uC694 \uC2DC\uAC04</span>
      </div>
      <div class="srs-stat">
        <span class="srs-stat-value">${s}</span>
        <span class="srs-stat-label">SM-2 \uC810\uC218</span>
      </div>
    `,this.renderAnswerBreakdown(n);let u=n.createEl("div",{cls:"srs-button-area"}),h=u.createEl("button",{text:"\uBCF5\uC2B5 \uAE30\uB85D\uC5D0 \uBC18\uC601",cls:"mod-cta"});h.onclick=()=>this.applyResultToReview(s);let v=u.createEl("button",{text:"\uB2EB\uAE30"});v.onclick=()=>this.close()}renderAnswerBreakdown(e){if(!this.quiz)return;let t=e.createEl("div",{cls:"srs-answer-breakdown"});t.createEl("h4",{text:"\uBB38\uC81C\uBCC4 \uACB0\uACFC"});let s=t.createEl("div",{cls:"srs-breakdown-list"});this.answers.forEach((r,n)=>{let a=this.quiz.questions[n];if(!a)return;let o=s.createEl("div",{cls:`srs-breakdown-item ${r.isCorrect?"is-correct":"is-incorrect"}`});o.innerHTML=`
        <span class="srs-breakdown-icon">${r.isCorrect?"\u2705":"\u274C"}</span>
        <span class="srs-breakdown-text">${this.truncate(a.question,40)}</span>
        <span class="srs-breakdown-time">${r.timeTaken}\uCD08</span>
      `})}renderError(){let{contentEl:e}=this,t=e.createEl("div",{cls:"srs-quiz-error"});t.createEl("div",{cls:"srs-error-icon",text:"\u26A0\uFE0F"}),t.createEl("h3",{text:"\uC624\uB958 \uBC1C\uC0DD"}),t.createEl("p",{text:this.errorMessage});let s=t.createEl("div",{cls:"srs-button-area"}),r=s.createEl("button",{text:"\uB2E4\uC2DC \uC2DC\uB3C4",cls:"mod-cta"});r.onclick=async()=>{this.state="loading",this.render(),await this.generateQuiz()};let n=s.createEl("button",{text:"\uB2EB\uAE30"});n.onclick=()=>this.close()}startQuiz(){this.currentIndex=0,this.answers=[],this.questionStartTime=Date.now(),this.state="question",this.render()}submitAnswer(){if(!this.quiz||!this.quizGenerator)return;let e=this.quiz.questions[this.currentIndex];if(!e)return;this.currentResult=this.quizGenerator.validateAnswer(e,this.currentAnswer);let t=Math.floor((Date.now()-this.questionStartTime)/1e3);this.answers.push({questionId:e.id,userAnswer:this.currentAnswer,isCorrect:this.currentResult.isCorrect,timeTaken:t}),this.state="feedback",this.render()}skipQuestion(){if(!this.quiz)return;let e=this.quiz.questions[this.currentIndex];if(!e)return;let t=Math.floor((Date.now()-this.questionStartTime)/1e3);this.answers.push({questionId:e.id,userAnswer:"",isCorrect:!1,timeTaken:t}),this.currentResult={isCorrect:!1,feedback:"\uAC74\uB108\uB6F0\uC5C8\uC2B5\uB2C8\uB2E4.",correctAnswer:e.correctAnswer},this.state="feedback",this.render()}nextQuestion(){this.quiz&&(this.currentIndex++,this.currentAnswer="",this.currentResult=null,this.questionStartTime=Date.now(),this.currentIndex>=this.quiz.questions.length?this.state="result":this.state="question",this.render())}async applyResultToReview(e){try{let t=te(this.file.path),s=this.plugin.getReviewRepository(),r=await s.getCard(t);if(!r){new I.Notice("\uBCF5\uC2B5 \uCE74\uB4DC\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4. \uBA3C\uC800 \uB178\uD2B8\uB97C \uBCF5\uC2B5 \uB300\uC0C1\uC73C\uB85C \uB4F1\uB85D\uD574\uC8FC\uC138\uC694."),this.close();return}let n=this.plugin.getScheduler(),a=n.calculateNext(r,e),o={...r,sm2State:a},l=n.estimateRetentionLevel(o);r.reviewHistory.push({reviewedAt:new Date,quality:e,mode:"quiz"}),r.sm2State=a,r.retentionLevel=l,r.lastModified=new Date,await s.saveCard(r),new I.Notice(`\uD034\uC988 \uACB0\uACFC\uAC00 \uBC18\uC601\uB418\uC5C8\uC2B5\uB2C8\uB2E4! \uB2E4\uC74C \uBCF5\uC2B5: ${a.interval}\uC77C \uD6C4`),this.plugin.updateBadge(),this.close()}catch(t){console.error("[SRS] Failed to apply quiz result:",t),new I.Notice("\uACB0\uACFC \uBC18\uC601 \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.")}}getScoreLabel(e){return e>=90?"\uC644\uBCBD\uD574\uC694! \u{1F389}":e>=75?"\uC798\uD588\uC5B4\uC694! \u{1F44F}":e>=60?"\uAD1C\uCC2E\uC544\uC694! \u{1F44D}":e>=40?"\uB354 \uB178\uB825\uD574\uBD10\uC694! \u{1F4AA}":"\uB2E4\uC2DC \uBCF5\uC2B5\uD574\uBCF4\uC138\uC694! \u{1F4DA}"}formatTime(e){if(e<60)return`${e}\uCD08`;let t=Math.floor(e/60),s=e%60;return`${t}\uBD84 ${s}\uCD08`}truncate(e,t){return e.length<=t?e:e.substring(0,t)+"..."}};var Fe={dailyLimit:20,newCardsPerDay:10,similarityThreshold:.7,clusterMinSize:3},K=class{constructor(i,e={}){this.config={...Fe,...e};let t=this.getTodayString();i&&i.lastActiveDate===t?this.sessionData=i:this.sessionData={currentSession:(i==null?void 0:i.currentSession)||null,lastActiveDate:t,reviewedTodayIds:[],newCardsIntroducedIds:[],clusterLastReviewed:(i==null?void 0:i.clusterLastReviewed)||{}}}getDailyQueue(){return{date:this.sessionData.lastActiveDate,focusSession:this.sessionData.currentSession,reviewedCount:this.sessionData.reviewedTodayIds.length,dailyLimit:this.config.dailyLimit,newCardsIntroduced:this.sessionData.newCardsIntroducedIds.length,newCardsLimit:this.config.newCardsPerDay}}selectTodayReviewNotes(i,e){var l;let t=new Date,s=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59),r=new Set(this.sessionData.reviewedTodayIds),n=i.filter(d=>r.has(d.noteId)?!1:new Date(d.sm2State.nextReview)<=s),a=this.config.dailyLimit-this.sessionData.reviewedTodayIds.length;if(a<=0)return[];if(((l=this.sessionData.currentSession)==null?void 0:l.status)==="active"){let d=this.getSessionNotes(n);if(d.length>0)return d.slice(0,a);this.completeCurrentSession()}return this.startNewSession(n,e)?this.getSessionNotes(n).slice(0,a):this.sortByPriority(n).slice(0,a)}selectNewCardsToIntroduce(i,e){let t=this.config.newCardsPerDay-this.sessionData.newCardsIntroducedIds.length;if(t<=0)return[];let s=new Set(this.sessionData.newCardsIntroducedIds),r=i.filter(n=>!s.has(n.noteId));if(this.sessionData.currentSession){let n=this.sessionData.currentSession.clusterId,a=e.find(o=>o.id===n);if(a){let o=new Set(a.noteIds),l=r.filter(u=>o.has(u.noteId)),d=r.filter(u=>!o.has(u.noteId));return[...l,...d].slice(0,t)}}return r.slice(0,t)}markReviewed(i,e){if(this.sessionData.reviewedTodayIds.includes(i)||this.sessionData.reviewedTodayIds.push(i),e&&!this.sessionData.newCardsIntroducedIds.includes(i)&&this.sessionData.newCardsIntroducedIds.push(i),this.sessionData.currentSession){let t=this.sessionData.currentSession;t.remainingNoteIds=t.remainingNoteIds.filter(s=>s!==i),t.reviewedTodayIds.includes(i)||t.reviewedTodayIds.push(i),t.lastActiveAt=new Date,t.remainingNoteIds.length===0&&this.completeCurrentSession()}}getCurrentSession(){return this.sessionData.currentSession}getPersistedData(){return{...this.sessionData}}startSessionForCluster(i,e){let t={id:`session_${Date.now()}`,clusterId:i.id,clusterLabel:i.label,noteIds:[...i.noteIds],remainingNoteIds:e.filter(s=>i.noteIds.includes(s)),reviewedTodayIds:[],startedAt:new Date,lastActiveAt:new Date,status:"active"};return this.sessionData.currentSession=t,t}pauseCurrentSession(){this.sessionData.currentSession&&(this.sessionData.currentSession.status="paused")}updateConfig(i){this.config={...this.config,...i}}getTodayString(){return new Date().toISOString().split("T")[0]}getSessionNotes(i){if(!this.sessionData.currentSession)return[];let e=new Set(this.sessionData.currentSession.remainingNoteIds);return i.filter(t=>e.has(t.noteId))}completeCurrentSession(){this.sessionData.currentSession&&(this.sessionData.currentSession.status="completed",this.sessionData.clusterLastReviewed[this.sessionData.currentSession.clusterId]=this.getTodayString(),this.sessionData.currentSession=null)}startNewSession(i,e){if(e.length===0)return null;let t=new Set(i.map(n=>n.noteId)),s=e.map(n=>({cluster:n,dueCount:n.noteIds.filter(a=>t.has(a)).length,lastReviewed:this.sessionData.clusterLastReviewed[n.id]||"1970-01-01"})).filter(n=>n.dueCount>0).sort((n,a)=>n.lastReviewed!==a.lastReviewed?n.lastReviewed.localeCompare(a.lastReviewed):a.dueCount-n.dueCount);if(s.length===0)return null;let r=s[0];return this.startSessionForCluster(r.cluster,Array.from(t))}sortByPriority(i){return[...i].sort((e,t)=>{let s=new Date(e.sm2State.nextReview).getTime(),r=new Date(t.sm2State.nextReview).getTime();return s!==r?s-r:e.sm2State.easeFactor!==t.sm2State.easeFactor?e.sm2State.easeFactor-t.sm2State.easeFactor:e.sm2State.repetition-t.sm2State.repetition})}};var Qe={minClusterSize:3};function we(c,i,e={}){let t={...Qe,...e},s=new Set(i.map(r=>r.noteId));return c.map(r=>{let n=r.noteIds.filter(o=>s.has(o)).length;return{id:r.id,label:r.name,noteIds:r.noteIds,centroid:r.centroid,dueCount:n,totalCount:r.noteIds.length}}).filter(r=>r.totalCount>=t.minClusterSize)}var ye="srs-session-data",U=class extends y.Plugin{constructor(){super(...arguments);this.ribbonEl=null}async onload(){console.log("[SRS] Loading Spaced Repetition Scheduler plugin"),await this.loadSettings(),await this.initializeServices(),this.initializeAI(),this.registerViews(),this.registerCommands(),this.addSettingTab(new A(this.app,this)),this.setupRibbonIcon(),this.registerEvents(),await this.updateBadge()}async onunload(){console.log("[SRS] Unloading Spaced Repetition Scheduler plugin"),await this.saveSessionData(),ae()}async loadSettings(){let e=await this.loadData();this.settings=Y(e||{})}async saveSettings(){await this.saveData(this.settings),this.initializeAI()}async resetSettings(){this.settings={...S},await this.saveSettings()}async initializeServices(){this.reviewRepository=new N(this.app),this.embeddingsReader=new O(this.app.vault),this.scheduler=new _,this.clusteringService=new $,this.reviewRepository.setEmbeddingsReader(this.embeddingsReader);let e=await this.loadSessionData(),t={dailyLimit:this.settings.review.dailyLimit,newCardsPerDay:this.settings.review.newCardsPerDay,similarityThreshold:this.settings.review.similarityThreshold};this.sessionManager=new K(e,t)}async loadSessionData(){try{let e=await this.loadData();return(e==null?void 0:e[ye])||null}catch(e){return console.error("[SRS] Failed to load session data:",e),null}}async saveSessionData(){try{let e=await this.loadData()||{};e[ye]=this.sessionManager.getPersistedData(),await this.saveData(e)}catch(e){console.error("[SRS] Failed to save session data:",e)}}initializeAI(){if(!this.settings.ai.apiKeys[this.settings.ai.provider]){this.settings.advanced.debugMode&&console.log("[SRS] No API key configured");return}re({provider:this.settings.ai.provider,modelId:this.settings.ai.model,apiKeys:this.settings.ai.apiKeys}),this.settings.advanced.debugMode&&console.log("[SRS] AI Service initialized with",this.settings.ai.provider)}registerViews(){this.registerView(D,e=>new H(e,this))}async activateDashboard(){let{workspace:e}=this.app,t=e.getLeavesOfType(D)[0];if(!t){let s=e.getRightLeaf(!1);s&&(t=s,await t.setViewState({type:D,active:!0}))}t&&e.revealLeaf(t)}registerCommands(){this.addCommand({id:"start-review",name:"\uBCF5\uC2B5 \uC2DC\uC791 (Start Review Session)",callback:()=>this.startReviewSession()}),this.addCommand({id:"open-dashboard",name:"\uB300\uC2DC\uBCF4\uB4DC \uC5F4\uAE30 (Open Dashboard)",callback:()=>this.activateDashboard()}),this.addCommand({id:"generate-quiz",name:"\uC774 \uB178\uD2B8 \uD034\uC988 \uC0DD\uC131 (Generate Quiz)",checkCallback:e=>{let t=this.app.workspace.getActiveFile();return t&&t.extension==="md"?(e||this.generateQuizForNote(t),!0):!1}}),this.addCommand({id:"show-due-today",name:"\uC624\uB298 \uBCF5\uC2B5\uD560 \uB178\uD2B8 (Due Today)",callback:()=>this.showDueToday()})}setupRibbonIcon(){this.ribbonEl=this.addRibbonIcon("brain","Spaced Repetition",()=>{this.startReviewSession()})}async updateBadge(){if(!this.settings.notifications.showBadge||!this.ribbonEl)return;let e=this.sessionManager.getDailyQueue(),t=e.dailyLimit-e.reviewedCount,s=Math.max(0,t);s>0?(this.ribbonEl.setAttribute("data-srs-badge",s.toString()),this.ribbonEl.addClass("srs-has-badge")):(this.ribbonEl.removeAttribute("data-srs-badge"),this.ribbonEl.removeClass("srs-has-badge"))}registerEvents(){}async startReviewSession(){let e=this.sessionManager.getDailyQueue(),t=e.dailyLimit-e.reviewedCount,s=e.newCardsLimit-e.newCardsIntroduced,r=await this.reviewRepository.getDueTodayCount(),n=(await this.reviewRepository.getUnintroducedCards()).length,a=r>0||n>0&&s>0,o=t>0;if(!a||!o){o?new y.Notice("\uC624\uB298 \uBCF5\uC2B5\uD560 \uB178\uD2B8\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4!"):new y.Notice(`\uC624\uB298 \uBCF5\uC2B5 \uD55C\uB3C4(${e.dailyLimit}\uAC1C)\uB97C \uC644\uB8CC\uD588\uC2B5\uB2C8\uB2E4!`);return}new G(this.app,this).open()}async generateQuizForNote(e){if(!this.settings.quiz.enabled){new y.Notice("\uD034\uC988 \uAE30\uB2A5\uC774 \uBE44\uD65C\uC131\uD654\uB418\uC5B4 \uC788\uC2B5\uB2C8\uB2E4. \uC124\uC815\uC5D0\uC11C \uD65C\uC131\uD654\uD574\uC8FC\uC138\uC694.");return}let t=ne();if(!t||!t.hasApiKey()){new y.Notice("AI \uC11C\uBE44\uC2A4\uAC00 \uC124\uC815\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4. \uC124\uC815\uC5D0\uC11C API \uD0A4\uB97C \uC785\uB825\uD574\uC8FC\uC138\uC694.");return}new V(this.app,this,e).open()}async showDueToday(){var u;let e=this.sessionManager.getDailyQueue(),t=await this.reviewRepository.getUnintroducedCards(),s=await this.reviewRepository.getDueTodayCount(),r=e.dailyLimit-e.reviewedCount,n=e.newCardsLimit-e.newCardsIntroduced,a=Math.min(s,r),o=Math.min(t.length,n,r-a);if(a+o===0){r===0?new y.Notice(`\uC624\uB298 \uBCF5\uC2B5 \uD55C\uB3C4(${e.dailyLimit}\uAC1C)\uB97C \uC644\uB8CC\uD588\uC2B5\uB2C8\uB2E4! \u{1F389}`):new y.Notice("\uC624\uB298 \uBCF5\uC2B5\uD560 \uB178\uD2B8\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4!");return}let d=((u=e.focusSession)==null?void 0:u.status)==="active"?`\u{1F4CC} \uD3EC\uCEE4\uC2A4: ${e.focusSession.clusterLabel}
`:"";new y.Notice(`${d}\uC624\uB298 \uBCF5\uC2B5 \uD604\uD669:
\u2022 \uC644\uB8CC: ${e.reviewedCount}/${e.dailyLimit}
\u2022 \uC2E0\uADDC \uB3C4\uC785: ${e.newCardsIntroduced}/${e.newCardsLimit}
\u2022 \uB0A8\uC740 due: ${s}\uAC1C
\u2022 \uBBF8\uB3C4\uC785 \uB178\uD2B8: ${t.length}\uAC1C`,5e3)}async testApiConnection(){let e=this.settings.ai.provider,t=this.settings.ai.apiKeys[e];if(!t)return!1;try{let s;if(e==="claude")s=new x;else if(e==="openai")s=new E;else return!1;return await s.testApiKey(t)}catch(s){return console.error("[SRS] API test failed:",s),!1}}getScheduler(){return this.scheduler}getReviewRepository(){return this.reviewRepository}getEmbeddingsReader(){return this.embeddingsReader}getClusteringService(){return this.clusteringService}getSessionManager(){return this.sessionManager}async selectTodayReviewCards(){let e=await this.reviewRepository.getAllCards(),t=await this.embeddingsReader.readAllEmbeddings(),s=Array.from(t.values()).map(m=>({noteId:m.noteId,vector:m.vector})),n=(await this.clusteringService.cluster(s,{threshold:this.settings.review.similarityThreshold,maxGroupSize:20})).groups,a=new Date,o=new Date(a.getFullYear(),a.getMonth(),a.getDate(),23,59,59),l=e.filter(m=>new Date(m.sm2State.nextReview)<=o),d=we(n,l),u=this.sessionManager.selectTodayReviewNotes(e,d),h=await this.reviewRepository.getUnintroducedCards(),v=this.sessionManager.selectNewCardsToIntroduce(h,d);for(let m of v)await this.reviewRepository.introduceNewCard(m.noteId);return{reviewCards:u,newCardsToIntroduce:v}}};
